<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>GSN</title>

<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
<link rel="stylesheet" href="style/tablesorter.css" type="text/css" media="screen,projection" />
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery-dom.js"></script>
<script type="text/javascript" src="js/jquery.history.js"></script>
<script type="text/javascript" src="js/jquery-tooltip.js"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>

<script type="text/javascript" src="js/constants.js"></script>
<script type="text/javascript" src="js/functions.js"></script>
<script type="text/javascript" src="js/uptime.js"></script>
<script type="text/javascript" src="js/protovis-d3.3.js"></script>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">
<!--//<![CDATA[

var deployments = new Array();
var deployment_data = new Array();
var current_deployment;
var selected_deployment;

var ACTIVE_TIMEOUT_MS = 2000;
var STANDBY_TIMEOUT_MS = 300000;

var MAPPING_BAR_HEIGHT = 18;
var MAPPING_BAR_SPACER = 5;

var rssi_dist = 25;
var topologyUpdateTimer;
var mappingUpdateTimer;
var deviceInfoUpdateTimer;
var deviceInfoUpdateIndex = 0;
var unmarkTimer;
var configitems=new Array("info","health","adcmux","adccomdiff","dcx","drift","events","rssi","statecounter","decagonmux","vaisala_wxt520","th3","enviroscan","modbus","wgps","powerswitch","powerswitch_p1","powerswitch_p2","timestamp");
var healthitems=new Array("packet_count", "vsys", "vsdi", "current", "temperature", "humidity","db_entries","flash_count","uptime","generation_time","timestamp");
var SIB = 1;
var WGPS = 2;
var POWERSWITCH = 3;
var BASESTATION = 4;
var GPSCORESTATION = 5;
var CAMZILLA = 6;
var GPSLOGGER = 7;
var WEBCAM = 8;
var AETINYNODE = 9;
var nodetypes = {1: "SIB TinyNode", 2: "GPS TinyNode", 3: "PowerSwitch TN", 4: "BaseStation", 5: "GPS CoreStation", 6: "CamZilla CoreStation", 7: "GPS Logger", 8: "Webcam", 9: "AE TinyNode", 10: "Outback Mate 3", 11: "IMIS Weather Station", 12: "GPS L2", 13: "DPP"};
var geoMarkersTypeToIconMap = {	1: {small: 'img/map-icons/map-icon-green-small-SIB.png', big: 'img/map-icons/map-icon-green-big-SIB.png', offlinesmall: 'img/map-icons/map-icon-red-small-SIB.png', offlinebig: 'img/map-icons/map-icon-red-big-SIB.png'},
				2: {small: 'img/map-icons/map-icon-green-small-WGPS.png', big: 'img/map-icons/map-icon-green-big-WGPS.png', offlinesmall: 'img/map-icons/map-icon-red-small-WGPS.png', offlinebig: 'img/map-icons/map-icon-red-big-WGPS.png'},
				3: {small: 'img/map-icons/map-icon-green-small-PowerSwitch.png', big: 'img/map-icons/map-icon-green-big-PowerSwitch.png', offlinesmall: 'img/map-icons/map-icon-red-small-PowerSwitch.png', offlinebig: 'img/map-icons/map-icon-red-big-PowerSwitch.png'},
				4: {small: 'img/map-icons/map-icon-green-small-BaseStation.png', big: 'img/map-icons/map-icon-green-big-BaseStation.png', offlinesmall: 'img/map-icons/map-icon-red-small-BaseStation.png', offlinebig: 'img/map-icons/map-icon-red-big-BaseStation.png'},
				5: {small: 'img/map-icons/map-icon-green-small-GPSCoreStation.png', big: 'img/map-icons/map-icon-green-big-GPSCoreStation.png', offlinesmall: 'img/map-icons/map-icon-red-small-GPSCoreStation.png', offlinebig: 'img/map-icons/map-icon-red-big-GPSCoreStation.png'},
				6: {small: 'img/map-icons/map-icon-green-small-CamZilla.png', big: 'img/map-icons/map-icon-green-big-CamZilla.png', offlinesmall: 'img/map-icons/map-icon-red-small-CamZilla.png', offlinebig: 'img/map-icons/map-icon-red-big-CamZilla.png'},
				7: {small: 'img/map-icons/map-icon-blue-small-GPSLogger.png', big: 'img/map-icons/map-icon-blue-big-GPSLogger.png', offlinesmall: 'img/map-icons/map-icon-blue-small-GPSLogger.png', offlinebig: 'img/map-icons/map-icon-blue-big-GPSLogger.png'},
				8: {small: 'img/map-icons/map-icon-purple-small-WebCam.png', big: 'img/map-icons/map-icon-purple-big-WebCam.png', offlinesmall: 'img/map-icons/map-icon-purple-small-WebCam.png', offlinebig: 'img/map-icons/map-icon-purple-big-WebCam.png'},
				9: {small: 'img/map-icons/map-icon-green-small-AE.png', big: 'img/map-icons/map-icon-green-big-AE.png', offlinesmall: 'img/map-icons/map-icon-red-small-AE.png', offlinebig: 'img/map-icons/map-icon-red-big-AE.png'},
				11: {small: 'img/map-icons/map-icon-blue-small-IMIS.png', big: 'img/map-icons/map-icon-blue-big-IMIS.png', offlinesmall: 'img/map-icons/map-icon-blue-small-IMIS.png', offlinebig: 'img/map-icons/map-icon-blue-big-IMIS.png'},
				12: {small: 'img/map-icons/map-icon-blue-small-GPSL2.png', big: 'img/map-icons/map-icon-blue-big-GPSL2.png', offlinesmall: 'img/map-icons/map-icon-blue-small-GPSL2.png', offlinebig: 'img/map-icons/map-icon-blue-big-GPSL2.png'},
				13: {small: 'img/map-icons/map-icon-green-small-DPP.png', big: 'img/map-icons/map-icon-green-big-DPP.png', offlinesmall: 'img/map-icons/map-icon-red-small-DPP.png', offlinebig: 'img/map-icons/map-icon-red-big-DPP.png'}};
var defaultGeoMarkerIcon = {small: 'img/map-icons/map-icon-orange-small-default.png', big: 'img/map-icons/map-icon-orange-big-default.png', offlinesmall: 'img/map-icons/map-icon-orange-small-default.png', offlinebig: 'img/map-icons/map-icon-orange-big-default.png'};

var infowindow = new google.maps.InfoWindow({content: 'test'});

Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

var GSN = {
  /**
    * iframe msg callback for webupload
    */
    msgcallback: function (msg,code) {
        $("#msg").html(msg);
        $("#msg").removeClass();
        if (code <= 200)
            $("#msg").addClass("good");
        else
            $("#msg").addClass("bad");
        $("#msg").append("<input style =\"margin-left:20px\" type=\"button\" value=\"OK\">");
        $("input[type=\"button\"]","#msg").bind("click", function () { $("#msg").hide(); $("#msg").empty();});
        $("#msg").show();
        resetconfigurations(true);
    }
}

function PacketRate() {
  this.packethistory = new Array();
  this.packetcount;
  this.rate = 0;
  
  this.update = function(packetcount) {
    if (!this.packetcount)
      this.packetcount=packetcount;
    var now=new Date().getTime();
    this.packethistory.push({rate : packetcount - this.packetcount, time : now});
    this.packetcount=packetcount;
    if (this.packethistory.length > 20)
      this.packethistory.shift();
    else if (this.packethistory.length == 1) {
      this.rate = parseFloat(0).toFixed(2);
      return;
    }
    var starttime=now, endtime=0, sum=0;
    $(this.packethistory).each(function(){
      sum = sum + this.rate;
      if (this.time < starttime) starttime = this.time;
      if (this.time > endtime) endtime = this.time;
    });
    this.rate = parseFloat((sum / (endtime-starttime) * 1000)).toFixed(2);
  }
  
}

  function nodeindex(id) {
    for (i=0;i<current_deployment.sensornodes.length;i++) {
      if (current_deployment.sensornodes[i].node_id==id)
        return i;
    }
    return -1;
  }

  function linkExists(links, testlink) {
    for (i=0;i<links.length;i++) {
      if (links[i].source==testlink.source && links[i].target==testlink.target && links[i].srcrssi==testlink.srcrssi && links[i].dstrssi==testlink.dstrssi)
        return true;
    }
    return false;
  }
  
  function deviceTypeIsCoreStation(type) {
    if (type > 3 && type < 7)
      return true;
    return false;
  }

  function updateTopologyGraph(network) {
    var topology_change=false;
    var oldlinks = current_deployment.links;
    current_deployment.links = new Array();
    $(current_deployment.sensornodes).each(function(index,value) {
      this.touched=false;
    });
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      
      var positionActive = true;
      if (current_deployment.deploymentHasMapping && $(this).attr("position") !== undefined && current_deployment.positionToDeviceIdMap[$(this).attr("position")] === undefined)
	positionActive = false;
      
      if (positionActive) {
	var index = nodeindex(id);
	if (index < 0) {
	  current_deployment.sensornodes.push({node_id : $(this).attr("node_id"), timestamp :  $(this).attr("timestamp"), touched : true, nodetype: $(this).attr("nodetype"), iscorestation: $(this).attr("iscorestation") == "true", corestation_online: $(this).attr("corestation_online") });
	  topology_change = true;
	}
	else {
	  current_deployment.sensornodes[index].timestamp = $(this).attr("timestamp");
	  current_deployment.sensornodes[index].touched = true;
	  current_deployment.sensornodes[index].nodetype = $(this).attr("nodetype");
	  current_deployment.sensornodes[index].corestation_online = $(this).attr("corestation_online");
	}
      }
    });
    
    var tmp = new Array();
    $(current_deployment.sensornodes).each(function(index,value) {
      if (this.touched)
        tmp.push(this);
      else {
        topology_change=true;
        removeIdFromTable(this.node_id);
      }
    });
    current_deployment.sensornodes = tmp;
    $("sensornode",network).each(function(){
      if ($(this).attr("parent_id")) {
        var src=nodeindex($(this).attr("node_id"));
        var dst=nodeindex($(this).attr("parent_id"));
        if (src >= 0 && dst >= 0) {
          var srcRssi = $($("links", this).children("[node_id='"+$(this).attr("parent_id")+"']")[0]).attr("rssi");
          var dstRssi = $($($(network).children("[node_id='"+$(this).attr("parent_id")+"']")[0]).find("link[node_id='"+$(this).attr("node_id")+"']")[0]).attr("rssi");
          if (srcRssi !== undefined || dstRssi !== undefined) {
	    var newlink = {source : src, target: dst, srcrssi : srcRssi, dstrssi : dstRssi};
	    current_deployment.links.push(newlink);
	    if (!linkExists(oldlinks, newlink))
	      topology_change=true;
	  }
        }
      }
    });

    current_deployment.force.nodes(current_deployment.sensornodes);
    current_deployment.force.links(current_deployment.links);

    if (topology_change) {
      current_deployment.force.reset();
      current_deployment.force.iterations(100);
    }
    else {
      current_deployment.force.iterations(1);
    }
    current_deployment.vis.render();
    
    if ($("#geo_graph_"+current_deployment.name).is(":visible")) {
      for (var i=0; i<current_deployment.geoLinks.length; i++)
	current_deployment.geoLinks[i].setMap(null);
      current_deployment.geoLinks.length = 0;
      for (i=0; i<current_deployment.links.length; i++) {
	if (current_deployment.links[i].source !== undefined &&
	  current_deployment.deviceIdMapping[current_deployment.sensornodes[current_deployment.links[i].source].node_id] !== undefined &&
	  current_deployment.geoMarkers[current_deployment.deviceIdMapping[current_deployment.sensornodes[current_deployment.links[i].source].node_id].position] !== undefined) {
	  var flightPath = new google.maps.Polyline({
	    path: [current_deployment.geoMarkers[current_deployment.deviceIdMapping[current_deployment.sensornodes[current_deployment.links[i].source].node_id].position].getPosition(), current_deployment.geoMarkers[current_deployment.deviceIdMapping[current_deployment.sensornodes[current_deployment.links[i].target].node_id].position].getPosition()],
	    clickable: false,
	    geodesic: true,
	    strokeColor: '#04B404',
	    strokeOpacity: 0.7,
	    strokeWeight: 2
	  });

	  flightPath.setMap(current_deployment.geoMap);
	  current_deployment.geoLinks.push(flightPath);
	}
      }
    }
  }

  function resetconfigurations(apply) {
    $(".configtable tbody>tr", "#topologycontainer").each(function() {
      if (!$(this).hasClass("disabled")) {
        $(this).addClass("disabled");
        $("td", this).each(function(){
          $("input:first", this).attr("disabled","true");
          if (!$("input:first",this).data("enabled_pending") || $("input:first",this).data("enabled")==$("input:first",this).data("enabled_pending"))
            $(this).removeClass("changing");
          // change if not equal
          if ($("input:first",this).data("enabled")=="true" && !$("input:first", this).attr("checked")) {
            $("input:first", this).attr("checked", "checked");
            if (apply)
              $(this).addClass("changing");
          }
          else if ($("input:first",this).data("enabled")=="false" && $("input:first", this).attr("checked")) {
            $("input:first", this).removeAttr("checked");
            if (apply)
              $(this).addClass("changing");
          }
        });
      }                
    });
    $("form", "#topologycontainer").remove();
  }

  function expandNull(z, digits) {
    z = ""+z;
    for (var i = z.length; i<digits;i++)
      z = "0"+z;
    return z;
  }

  function formatTime(t) {
    if (!t)
      return "";
    else {      
      var d = new Date(0);
      d.setUTCMilliseconds(t);
      return (1900+d.getYear())+"-"+expandNull(d.getMonth()+1,2)+"-"+expandNull(d.getDate(),2)+" "+expandNull(d.getHours(),2)+":"+expandNull(d.getMinutes(),2)+":"+expandNull(d.getSeconds(),2)+" "+(d.getTimezoneOffset()<0?"+":"")+(-d.getTimezoneOffset()/60)+":00";
    }
  }

  function unmarkNewData() {
     $("tbody", "#topology_"+current_deployment.name).find("tr").each(function() {
      $(this).removeClass("newdata");
    });
  }

  function removeIdFromTable(id) {
    var table = $("tbody", "#topology_"+current_deployment.name);
    $("tr", table).each(function() {
      if ($(this).find(">:nth-child(2)").text()==id)
        $(this).remove();}
    );
  }

  function updateHealthTable(network) {
    var tablesorter = $("#topology_"+current_deployment.name).find(".healthtable table");
    var table = tablesorter.find("tbody");
    var sortlist = $(tablesorter).get(0).config.sortList;
    if (sortlist.length == 0)
      sortlist = [[0,0]];
    var tableChanged = false;
    var now=new Date().getTime();
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      
      var positionActive = true;
      if (current_deployment.deploymentHasMapping && $(this).attr("position") !== undefined && current_deployment.positionToDeviceIdMap[$(this).attr("position")] === undefined)
	positionActive = false;
      
      if (positionActive) {
	var index = nodeindex(id);
	if (index < 0) {
	  var cols='';
	  for (i=0;i<healthitems.length;i++)
	    cols+='<td></td>';
	  table.append("<tr>"+
	    "<td style=\"display:none\"></td><td>"+parseInt($(this).attr("node_id"))+'</td>'+cols+'<td></td>'+
	    "</tr>");
	}
	var row = $("td:nth-child(2)", table).filter(function(index) { return $(this).text()==id;}).parent();
	var data = this;
	if (index < 0 || ($(this).attr("timestamp") !== undefined && $(this).attr("timestamp") > current_deployment.sensornodes[index].timestamp)) {
	  $("td", row).each(function(index,value) {
	    switch (index) {
	    case 0:
	      if (current_deployment.deploymentHasMapping && current_deployment.deviceIdMapping[$(data).attr("node_id")] !== undefined && current_deployment.deviceIdMapping[$(data).attr("node_id")].position !== undefined)
		$(this).empty().text(current_deployment.deviceIdMapping[$(data).attr("node_id")].position);
	      else if ($(data).attr("position") !== undefined)
		$(this).empty().text($(data).attr("position"));
	      else
		$(this).empty().text("?");
	      break;
	    case 1: break; // node id
	    case 3:
	      var img;
	      $(this).empty();
	      if (current_deployment.deploymentHasMapping) {
		if (!$(data).attr('batterylevel'))
		  img = 'none';
		else if ($(data).attr('batterylevel')<=5)
		  img = 'empty';
		else if ($(data).attr('batterylevel')<=25)
		  img = 'quarter';
		else if ($(data).attr('batterylevel')<=50)
		  img = 'half';
		else
		  img = 'full';
		$(this).text($(data).attr(healthitems[index-2])?$(data).attr(healthitems[index-2]):"");
	      }
	      else
		img = 'none';
	      $(this).append('<img style="margin:0px 0px 0px 5px;vertical-align:middle;" src="img/batterylevels/battery_'+img+'.png">');
	      break;
	    case 4:
	    case 5:
	    case 6:
	    case 7:
	      if (current_deployment.deploymentHasMapping)
		$(this).text($(data).attr(healthitems[index-2])?$(data).attr(healthitems[index-2]):"");
	      break;
	    case 11:
	    case 12:
	      $(this).text(formatTime($(data).attr(healthitems[index-2])));
	      break;
	    case 13:
	      break;
	    default:
	      $(this).text($(data).attr(healthitems[index-2])?$(data).attr(healthitems[index-2]):"");
	      break;
	    }
	  });
	  $(row).addClass("newdata");
	  $(row).removeClass("offline");
	  $("td:nth-child(2)", $("#topology_"+current_deployment.name).find(".configtable tbody")).filter(function(index) { return $(this).text()==id;}).parent().removeClass("offline");
	  tableChanged = true;
	}
	if ($(this).attr("packet_count")) {
	  if (!$(row).data("packetrate"))
	    $(row).data("packetrate", new PacketRate());
	  $(row).data("packetrate").update($(this).attr("packet_count"));
	  $("td:last-child",row).text($(row).data("packetrate").rate);
	}
	if ($(this).attr("timestamp") === undefined || now - $(data).attr("timestamp") > STANDBY_TIMEOUT_MS) {
	  $(row).addClass("offline");
	  $("td:nth-child(2)", $("#topology_"+current_deployment.name).find(".configtable tbody")).filter(function(index) { return $(this).text()==id;}).parent().addClass("offline");
	}
      }
    });
    
    if ($(network).parent().attr("mapped")=='true') {
      $("td:first-child", table).each(function() {
        $(this).css('display', '');
      });
      var test = tablesorter.find("th:first-child");
      $(tablesorter.find("th:first-child")[0]).css('display', '');
    }
    tablesorter.trigger("update");
    if (sortlist.length > 0)
      tablesorter.trigger("sorton", [sortlist]);
    if (tableChanged) {
      if (unmarkTimer)
        clearTimeout(unmarkTimer); 
      unmarkTimer = setTimeout("unmarkNewData()",500);
    }    
  }

  function updateConfigTable(network, isConfigurable) {
    var tablesorter = $("#topology_"+current_deployment.name).find(".configtable table");;
    var table = tablesorter.find("tbody");
    var sortlist = $(tablesorter).get(0).config.sortList;
    if (sortlist.length == 0)
      sortlist = [[0,0]];
    var tableChanged = false;
    var now=new Date().getTime();
    
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      
      var positionActive = true;
      if (current_deployment.deploymentHasMapping && $(this).attr("position") !== undefined && current_deployment.positionToDeviceIdMap[$(this).attr("position")] === undefined)
	positionActive = false;
      
      if (positionActive) {
	var index = nodeindex(id);
	if (index < 0) {
	  table.append("<tr class=\"disabled\">"+
	    "<td style=\"display:none\">"+($(this).attr("position")?$(this).attr("position"):"")+"</td><td>"+parseInt($(this).attr("node_id"))+"</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>"+
	    "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
	  if (isConfigurable)
	  $("tr:last", table).bind("click",function() {
	    if (!$(this).hasClass("disabled"))
	      return;
	    $("input",this).each(function(){
	      $(this).removeAttr("disabled");
	    });
	    $(this).removeClass("disabled");
	    if ($(".configtab input", "#topology_"+current_deployment.name).length==0) {
	      // add config form
	      var configtab = $(".configtab", "#topology_"+current_deployment.name);
	      configtab.append("<form action=\"/upload\" method=\"post\" enctype=\"multipart/form-data\" target=\"webupload\">"+
		  "<input type=\"submit\" value=\"apply\">"+
		  "<input type=\"button\" value=\"reset\">"+
		  "<input type=\"hidden\" name=\"vsname\" value=\""+current_deployment.topology_vs_name+"\">"+
		  "<input type=\"hidden\" name=\"cmd\" value=\"dataconfiguration\">"+
		  "<input type=\"hidden\" name=\"dataconfiguration;configuration\" value=\"\">"+
		  "</form>"
	      );
	      $("input:first", configtab).bind("click", function () {
		// generate xml configuration
		var generated_config="<?xml version=\"1.0\" encoding=\"UTF-8\"?><network><sensornodes>";
		$(".configtable tbody>tr", "#topology_"+current_deployment.name).each(function() {
		  if (!$(this).hasClass("disabled")) {
		    generated_config=generated_config+"<sensornode node_id=\""+$("td:nth-child(2)",this).text()+"\"><links />";
		    var c = "";
		    $("td", this).each(function(index,value) {
		      switch (index) {
		      case 0:
		      case 1: break;
		      case 3: // always enable health ..
		      case 8: //  .. and event packets
			c = c + " "+configitems[index-2]+"=\"true\"";
			break;
		      case 20: break;
		      default:
			if ($(this).children().length > 0)
			  c = c + " "+configitems[index-2]+"=\"" + ($("input:first", this).attr("checked")?"true":"false")+"\"";
		      }
		    });
		    if (c.length>0)
		      generated_config=generated_config+"<configuration "+$.trim(c)+" />";
		    generated_config=generated_config+"</sensornode>";
		  }
		});
		generated_config=generated_config+"</sensornodes></network>";
		$("#debug").append(generated_config);
		$("input[name='dataconfiguration;configuration']", configtab).attr("value", generated_config);
		// submit
		$("form", configtab).submit();
	      });
	      // bind reset button
	      $("input[type='button']", configtab).bind("click", function () {
		resetconfigurations(false);
	      });
	    }
	    
	  });
	  $("tr:last", table).hover(function() { $(this).parent().children().each(function(){$(this).removeClass("selected")});$(this).addClass("selected"); }, function() { $(this).removeClass("selected"); });
	}
      }
      var row = $("td:nth-child(2)", table).filter(function(index) { return $(this).text()==id;}).parent();
      var hasConfig = $("configuration", this).length>0;
      var hasPendingConfig = $("pendingConfiguration", this).length>0;
      var update=false;
      var timestamp;
      if (hasConfig) {
        // do we need to update?
        if (!$(row).data("hasConfig") || $(row).data("hasConfig")!=hasConfig)
          update=true;
        else if (hasPendingConfig && (!$(row).data("hasPendingConfig") || $(row).data("hasPendingConfig")!=hasPendingConfig))
          update=true;
        else if ($(row).data("hasPendingConfig") && !hasPendingConfig)
          update=true;
        else {
          if ($("configuration",this).attr("timestamp"))
            timestamp = $("configuration",this).attr("timestamp");
          if ($("pendingConfiguration",this).attr("timestamp") && (!timestamp || $("pendingConfiguration",this).attr("timestamp")>timestamp))
            timestamp = $("pendingConfiguration",this).attr("timestamp");
          if (!row.data("timestamp") || row.data("timestamp") < timestamp) {
            update=true;
            row.data("timestamp", timestamp);
          }
        }
        $(row).data("hasConfig",hasConfig);
        if (!hasPendingConfig)
          $(row).data("hasPendingConfig","");
        else
          $(row).data("hasPendingConfig",hasPendingConfig);
      }
      if (update) {
        var data = $("configuration",this);
        $("td", row).each(function(index,value) {
            switch (index) {
            case 0:
            case 1: break;
            case 20:
              $(this).text(formatTime($(data).attr(configitems[index-2])));
              break;
            default:
              if ($(data).attr(configitems[index-2])) {
                // fill empty cell
                if ($(this).children().length == 0) {
                  $(this).append("<div><input type=\"checkbox\" disabled=\""+($(this).parent().hasClass("disabled")?"disabled":"")+"\"></div>");                  
                }
                $("input:first", this).data("enabled", $(data).attr(configitems[index-2]));
                var pending = $(data).parent().children("pendingConfiguration");
                if (pending.length>0 && pending.attr(configitems[index-2]))
                  $("input:first", this).data("enabled_pending", pending.attr(configitems[index-2]));
                else
                  $("input:first", this).data("enabled_pending","");
                if ($(this).parent().hasClass("disabled")) { // if not changeable, just update
                  if (pending.length>0 && pending.attr(configitems[index-2]) && pending.attr(configitems[index-2]) != $(data).attr(configitems[index-2]))
                    $(this).addClass("changing");
                  else
                    $(this).removeClass("changing");
                  if ($(data).attr(configitems[index-2])=="true")
                    $("input:first", this).attr("checked", "checked");
                  else
                    $("input:first", this).removeAttr("checked");
                }
                else {// compare to current status
                  if ($("input:first", this).attr("checked") && $(data).attr(configitems[index-2])=="true" ||
                      !$("input:first", this).attr("checked") && $(data).attr(configitems[index-2])=="false")
                    $(this).removeClass("changing");
                  else
                    $(this).addClass("changing");
                }
              }
              else {
                // remove content
                $(this).empty();
              }
              break;
            }
        });
        $(row).addClass("newdata");
        tableChanged = true;
      }
    });
    
    if ($(network).parent().attr("mapped")=='true') {
      $("td:first-child", table).each(function() {
        $(this).css('display', '');
      });
      var test = tablesorter.find("th:first-child");
      $(tablesorter.find("th:first-child")[0]).css('display', '');
    }
    if (tableChanged) {
      tablesorter.trigger("update");
      if (sortlist.length > 0)
        tablesorter.trigger("sorton", [sortlist]);
      if (unmarkTimer)
        clearTimeout(unmarkTimer); 
      unmarkTimer = setTimeout("unmarkNewData()",500);
    }
  }

  function updateStatusBar(network) {
    var packetcount = 0;
    var nodeonlinecount = 0;
    var now=new Date().getTime();
    $("sensornode",network).each(function(){
      packetcount = packetcount+parseInt($(this).attr("packet_count"));
      if (now - $(this).attr("timestamp") <= STANDBY_TIMEOUT_MS)
        nodeonlinecount = nodeonlinecount + 1;
    });
    var nodetotalcount = current_deployment.sensornodes.length;
    current_deployment.packethistory.update(packetcount);
    $(".statusbar", "#topology_"+current_deployment.name).empty();
    $(".statusbar", "#topology_"+current_deployment.name).append("Total: "+nodetotalcount+"<br>Online: "+nodeonlinecount+"<br>Packetrate: "+current_deployment.packethistory.rate+" Pkts/s");
  }

  function fetchTopologyInfo() {
    $.ajax({
      type: "GET",
      url: "/field?vs="+current_deployment.topology_vs_name+"&field=DATA&pk=latest",
      dataType: "xml",
      success: function(data){
	try {
	  updateConfigTable($("sensornodes",data), $("network", data).attr("configurable")=="true");
	} catch (err) { console.log(err); }
	try {
	  updateHealthTable($("sensornodes",data));
	} catch (err) { console.log(err); }
	try {
	  updateTopologyGraph($("sensornodes",data));
	} catch (err) { console.log(err); }
	try {
	  updateStatusBar($("sensornodes",data));
	} catch (err) { console.log(err); }
	restartTimer();
      },
      error : function(XMLHttpRequest, textStatus, errorThrown) {
	restartTimer();
      }
    });
  }
  
  function checkBackLogConfig(deviceId) {
    $.ajax({
      type: "GET",
      url: "/field?vs="+current_deployment.name+"_backlogconfig__mapped&field=CONFIGURATION&position="+current_deployment.deviceIdMapping[deviceId].position+"&timeline=generation_time",
      dataType: "text",
      success: function(data){
	try {
	  var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	  if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined) {
	    if ($.trim(data))
	      current_deployment.deviceIdMapping[id].configuration = data;
	    else
	      current_deployment.deviceIdMapping[id].configuration = "<empty configuration>";
	  }
	  deviceInfoUpdateIndex++;
	  updateDeviceInfo();
	}
	catch (err) {
	  console.log(err);
	  restartTimer();
	}
      },
      error : function(XMLHttpRequest, textStatus, errorThrown) {
	try {
	  var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	  if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined)
	    current_deployment.deviceIdMapping[id].configuration = "<no configuration available>";
	  deviceInfoUpdateIndex++;
	  updateDeviceInfo();
	}
	catch (err) {
	  console.log(err);
	  restartTimer();
	}
      }
    });
  }
  
  function checkSchedule(deviceId) {
    $.ajax({
      type: "GET",
      url: "/field?vs="+current_deployment.name+"_schedule__mapped&field=SCHEDULE&position="+current_deployment.deviceIdMapping[deviceId].position+"&timeline=generation_time",
      dataType: "text",
      success: function(data){
	try {
	  var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	  if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined) {
	    if ($.trim(data))
	      current_deployment.deviceIdMapping[id].schedule = data;
	    else
	      current_deployment.deviceIdMapping[id].schedule = "<empty schedule>";
	    checkBackLogConfig(id);
	  }
	  else {
	    deviceInfoUpdateIndex++;
	    updateDeviceInfo();
	  }
	}
	catch (err) {
	  console.log(err);
	  restartTimer();
	}
      },
      error : function(XMLHttpRequest, textStatus, errorThrown) {
	try {
	  var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	  if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined) {
	    current_deployment.deviceIdMapping[id].schedule = "<no schedule available>";
	    checkBackLogConfig(id);
	  }
	  else {
	    deviceInfoUpdateIndex++;
	    updateDeviceInfo();
	  }
	}
	catch (err) {
	  console.log(err);
	  restartTimer();
	}
      }
    });
  }
  
  function updateDeviceInfo() {
    if (Object.size(current_deployment.deviceIdMapping) > 0) {
      if (deviceInfoUpdateIndex >= Object.size(current_deployment.deviceIdMapping)) {
	deviceInfoUpdateIndex = 0;
	fetchTopologyInfo();
	return;
      }
      
      var deviceId = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
      var type = current_deployment.deviceIdMapping[deviceId].type;
      if (type == BASESTATION || type == GPSCORESTATION || type == CAMZILLA) {
	$.ajax({
	  type: "GET",
	  url: "/field?vs="+current_deployment.name.toLowerCase()+"_camera_pos"+current_deployment.deviceIdMapping[deviceId].position+"__scaled&field=GENERATION_TIME&pk=latest&timeline=GENERATION_TIME",
	  dataType: "text",
	  success: function(data) {
	    try {
	      var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	      if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined) {
		if ($.trim(data))
		  current_deployment.deviceIdMapping[id].jpeg_timestamp = data;
		  
		checkSchedule(id);
	      }
	      else {
		deviceInfoUpdateIndex++;
		updateDeviceInfo();
	      }
	    }
	    catch (err) {
	      console.log(err);
	      restartTimer();
	    }
	  },
	  error : function(XMLHttpRequest, textStatus, errorThrown) {
	    try {
	      var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	      if (id !== undefined)
		checkSchedule(id);
	      else {
		deviceInfoUpdateIndex++;
		updateDeviceInfo();
	      }
	    }
	    catch (err) {
	      console.log(err);
	      restartTimer();
	    }
	  }
	});
      }
      else if (type == WGPS) {
	$.ajax({
	  type: "GET",
	  url: "/data?vsName="+current_deployment.name.toLowerCase()+"_dozer_wgps__config&fields=generation_time&fields=gps_sampling_interval&fields=status_sampling_interval&fields=high_power_start_time&fields=high_power_stop_time&fields=low_power_start_time&fields=low_power_stop_time&fields=low_power_entry_voltage&fields=low_power_exit_voltage&fields=bat_voltage_avg_buffer_size&critfield=position&critval="+current_deployment.deviceIdMapping[deviceId].position+"&critop==&neg=&nb=1&orderby=generation_time",
	  dataType: "text",
	  success: function(data){
	    try {
	      var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	      if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined && $("field:eq(10)", data).text()) {
		var arr = new Array();
		var unit = ["sec","min"," UTC"," UTC"," UTC"," UTC","V","V",""];
		for (var i=11; i<20; i++) {
		  var field = $("field:eq("+i+")", data).text();
		  if (field.toLowerCase() === "null")
		    arr[i-11] = "default or unknown";
		  else {
		    if (i>=13 && i<=16)
		      field = (field.length == 1) ? "0"+field+":00": field+":00";
		    arr[i-11] = field + unit[i-11];
		  }
		}
		current_deployment.deviceIdMapping[id].wgps_schedule = "<br>Configuration ("+formatTime($("field:eq(10)", data).text())+"):<br><div style=\"margin:0 5px 5px 5px\"><table cellpadding=\"2\" cellspacing=\"1\" style=font-size:10px;background-color:#eee\"><colgroup><col width=\"200\"><col width=\"100\"></colgroup>" +
		  "<tr><th style=\"background-color:#eee;font-size:11px\">Description</th><th style=\"background-color:#eee;font-size:11px\">Value</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">GPS sampling interval</th><th style=\"background-color:#eee\">" + arr[0] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Status sampling interval</th><th style=\"background-color:#eee\">" + arr[1] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">High power start time</th><th style=\"background-color:#eee\">" + arr[2] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">High power stop time</th><th style=\"background-color:#eee\">" + arr[3] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Low power start time</th><th style=\"background-color:#eee\">" + arr[4] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Low power stop time</th><th style=\"background-color:#eee\">" + arr[5] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Low power entry voltage</th><th style=\"background-color:#eee\">" + arr[6] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Low power exit voltage</th><th style=\"background-color:#eee\">" + arr[7] + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Battery voltage averaging buffer size</th><th style=\"background-color:#eee\">" + arr[8] + "</th></tr></table></div>" +
		  "<div style=font-size:10px;>(This configuration may not be the one operating on the device.<br>This may happen, if the answer to a new configuration is still in transit.)</div>";
	      }
	      deviceInfoUpdateIndex++;
	      updateDeviceInfo();
	    }
	    catch (err) {
	      console.log(err);
	      restartTimer();
	    }
	  },
	  error : function(XMLHttpRequest, textStatus, errorThrown) {
	    deviceInfoUpdateIndex++;
	    updateDeviceInfo();
	  }
	});
      }
      else if (type == POWERSWITCH) {
	$.ajax({
	  type: "GET",
	  url: "/data?vsName="+current_deployment.name.toLowerCase()+"_dozer_powerswitch__config&fields=generation_time&fields=schedule_power_on_port1&fields=schedule_power_off_port1&fields=schedule_power_on_port2&fields=schedule_power_off_port2&critfield=position&critval="+current_deployment.deviceIdMapping[deviceId].position+"&critop==&neg=&nb=1&orderby=generation_time",
	  dataType: "text",
	  success: function(data){
	    try {
	      var id = Object.keys(current_deployment.deviceIdMapping).sort()[deviceInfoUpdateIndex];
	      if (id !== undefined && current_deployment.deviceIdMapping[id] !== undefined && $("field:eq(5)", data).text()) {
		current_deployment.deviceIdMapping[id].wgps_schedule = "<br>Configuration ("+formatTime($("field:eq(5)", data).text())+"):<br><div style=\"margin:0 5px 5px 5px\"><table cellpadding=\"2\" cellspacing=\"1\" style=font-size:10px;background-color:#eee\"><colgroup><col width=\"200\"><col width=\"100\"></colgroup>" +
		  "<tr><th style=\"background-color:#eee;font-size:11px\">Description</th><th style=\"background-color:#eee;font-size:11px\">Value</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Power on port 1</th><th style=\"background-color:#eee\">" + $("field:eq(6)", data).text() + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Power off port 1</th><th style=\"background-color:#eee\">" + $("field:eq(7)", data).text() + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Power on port 2</th><th style=\"background-color:#eee\">" + $("field:eq(8)", data).text() + "</th></tr>" +
		  "<tr><th style=\"background-color:#eee\">Power off port 2</th><th style=\"background-color:#eee\">" + $("field:eq(9)", data).text() + "</th></tr></table></div>" +
		  "<div style=font-size:10px;>(This configuration may not be the one operating on the device.<br>This may happen, if the answer to a new configuration is still in<br>transit. In addition to that, the listed times have been correct when<br>this configuration has been set. Since then clock drifts may have<br>shifted it.)</div>";
	      }
	      deviceInfoUpdateIndex++;
	      updateDeviceInfo();
	    }
	    catch (err) {
	      console.log(err);
	      restartTimer();
	    }
	  },
	  error : function(XMLHttpRequest, textStatus, errorThrown) {
	    deviceInfoUpdateIndex++;
	    updateDeviceInfo();
	  }
	});
      }
      else {
	deviceInfoUpdateIndex++;
	updateDeviceInfo();
      }
    }
    else {
      fetchTopologyInfo();
    }
  }
  
  function restartTimer() {
    current_deployment.isTopologyUpdating = false;
    if (current_deployment.name !== selected_deployment.name)
      deviceInfoUpdateIndex = 0;
    current_deployment = selected_deployment;
    topologyUpdateTimer = setTimeout("fetchMappingInfo()",5000);
  }

  function fetchMappingInfo() {
    if (!current_deployment.isTopologyUpdating) {
      current_deployment.isTopologyUpdating = true;
      
      if (current_deployment.deploymentHasMapping) {
	$.ajax({
	  type: "GET",
	  url: "/field?vs="+current_deployment.name+"_mapping_chart&field=DATA&pk=latest",
	  dataType: "xml",
	  success: function(data){
	    try {
	      generateDeviceIdMapping($("positionMappings",data));
	      if($("#mapping_graph_"+current_deployment.name).is(":visible"))
		updatePositionMappingGraph(parseInt($("deviceMappings", data).attr("positionTimeMin")), $("positionMappings",data));
	      else if ($("#geo_graph_"+current_deployment.name).is(":visible"))
		updateGeoMap($("geoMappings",data));
	      
	      updateDeviceInfo();
	    }
	    catch (err) {
	      console.log(err);
	      restartTimer();
	    }
	  },
	  error : function(XMLHttpRequest, textStatus, errorThrown) {
	    updateDeviceInfo();
	  }
	});
      }
      else
	fetchTopologyInfo();
    }
  }
  
  function generateDeviceIdMapping(positionMaps) {
    var now = new Date().getTime()
    current_deployment.positionToDeviceIdMap = new Object();
    
    $("positionContainer", positionMaps).each(function() {
      var pos = parseInt($(this).attr("position"));
      $("positionMap", this).each(function() {
        var begin = parseInt($(this).attr("begin"));
        var end = parseInt($(this).attr("end"));
        if ((begin <= now && isNaN(end)) || (begin <= now && end > now)) {
	  var id = parseInt($(this).attr("device_id"));
	  if (current_deployment.deviceIdMapping[id] === undefined)
	    current_deployment.deviceIdMapping[parseInt($(this).attr("device_id"))] = {position : pos, type : parseInt($(this).attr("device_type")), end : end, comment : $(this).attr("comment")};
	  else {
	    current_deployment.deviceIdMapping[id].position = pos;
	    current_deployment.deviceIdMapping[id].type = parseInt($(this).attr("device_type"));
	    current_deployment.deviceIdMapping[id].end = end;
	    current_deployment.deviceIdMapping[id].comment = $(this).attr("comment");
	  }
	  current_deployment.positionToDeviceIdMap[pos] = id;
	}
      });
    });
      
    if (Object.size(current_deployment.positionToDeviceIdMap) < Object.size(current_deployment.deviceIdMapping)) {
      var delArr = new Array();
      for (var id in current_deployment.deviceIdMapping) {
	if (current_deployment.positionToDeviceIdMap[current_deployment.deviceIdMapping[id].position] === undefined)
	  delArr.push(id);
      }
      for (var index in delArr)
	delete current_deployment.deviceIdMapping[delArr[index]];
    }
  }

  function updateGeoMap(geoMaps) {
    var hasNewMarker = false;
    $("geoMappings", geoMaps).each(function() {
      var pos = parseInt($(this).attr("position"));
      if (current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]] !== undefined) {
	if (!current_deployment.geoMarkers[pos]) {
	  if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] === undefined || !current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].online)
	    current_deployment.geoMarkers[pos] = new google.maps.Marker({map: current_deployment.geoMap, icon: getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).offlinesmall});
	  else
	    current_deployment.geoMarkers[pos] = new google.maps.Marker({map: current_deployment.geoMap, icon: getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).small});
	  current_deployment.geoMarkers[pos].setPosition(new google.maps.LatLng(parseFloat($(this).attr("latitude")), parseFloat($(this).attr("longitude"))));
	  current_deployment.geoMarkers[pos].setTitle("Position " + pos + "\n\n" + $(this).attr("comment") + "\ndevice_id=" + current_deployment.positionToDeviceIdMap[pos]);
	  google.maps.event.addListener(current_deployment.geoMarkers[pos], 'mouseover', function() {
	    current_deployment.geoMarkers[pos].setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
	    if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] === undefined || !current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].online)
	      current_deployment.geoMarkers[pos].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).offlinebig);
	    else
	      current_deployment.geoMarkers[pos].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).big);
	    if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] !== undefined) {
	      current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].selected = true;
	      current_deployment.node.render();
	    }
	  });
	  google.maps.event.addListener(current_deployment.geoMarkers[pos], 'mouseout', function() {
	    if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] === undefined || !current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].online)
	      current_deployment.geoMarkers[pos].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).offlinesmall);
	    else
	      current_deployment.geoMarkers[pos].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[current_deployment.positionToDeviceIdMap[pos]].type).small);
	    if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] !== undefined) {
	      current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].selected = false;
	      current_deployment.node.render();
	    }
	  });
	  google.maps.event.addListener(current_deployment.geoMarkers[pos], 'click', function() {
	    var id = current_deployment.positionToDeviceIdMap[pos];
	    if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])] !== undefined)
	      showNodeInfoTab(id, current_deployment.deviceIdMapping[id].type, current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[pos])].corestation_online);
	    else
	      showNodeInfoTab(id, current_deployment.deviceIdMapping[id].type, "?");
	  });
	  hasNewMarker = true;
	}
	if(current_deployment.geoMarkers[pos].getPosition().lat().toFixed(6) != parseFloat($(this).attr("latitude")).toFixed(6) || current_deployment.geoMarkers[pos].getPosition().lng().toFixed(6) != parseFloat($(this).attr("longitude")).toFixed(6))
	  current_deployment.geoMarkers[pos].setPosition(new google.maps.LatLng(parseFloat($(this).attr("latitude")), parseFloat($(this).attr("longitude"))));
	if(current_deployment.geoMarkers[pos].getTitle() != ("Position " + pos + "\n\n" + $(this).attr("comment") + "\ndevice_id=" + current_deployment.positionToDeviceIdMap[pos]))
	  current_deployment.geoMarkers[pos].setTitle("Position " + pos + "\n\n" + $(this).attr("comment") + "\ndevice_id=" + current_deployment.positionToDeviceIdMap[pos]);
      }
      else if (current_deployment.geoMarkers[pos] !== undefined) {
	current_deployment.geoMarkers[pos].setMap(null);
	delete current_deployment.geoMarkers[pos];
      }
    });
    if (hasNewMarker) {
      var latMin, latMax, lngMin, lngMax;
      var bounds = new google.maps.LatLngBounds ();
      for (var mark in current_deployment.geoMarkers) {
	if (latMin === undefined || latMin > current_deployment.geoMarkers[mark].getPosition().lat())
	  latMin = current_deployment.geoMarkers[mark].getPosition().lat();
	if (latMax === undefined || latMax < current_deployment.geoMarkers[mark].getPosition().lat())
	  latMax = current_deployment.geoMarkers[mark].getPosition().lat();
	if (lngMin === undefined || lngMin > current_deployment.geoMarkers[mark].getPosition().lng())
	  lngMin = current_deployment.geoMarkers[mark].getPosition().lng();
	if (lngMax === undefined || lngMax < current_deployment.geoMarkers[mark].getPosition().lng())
	  lngMax = current_deployment.geoMarkers[mark].getPosition().lng();
	
	bounds.extend(current_deployment.geoMarkers[mark].getPosition());
      }
      current_deployment.geoMap.setCenter(new google.maps.LatLng(latMin+(latMax-latMin)/2.0,lngMin+(lngMax-lngMin)/2.0));
      current_deployment.geoMap.fitBounds(bounds);
    }
  }

  function updatePositionMappingGraph(positionTimeMin, positionMaps) {
	  var now = new Date().getTime();
	  var map = new Array();
	  var x = pv.Scale.linear(positionTimeMin, now+2592000000).range(0,895);
	  $("positionContainer", positionMaps).each(function() {
		  var devices = new Array();
		  var pos = parseInt($(this).attr("position"));
		  $("positionMap", this).each(function() {
			  devices.push([parseInt($(this).attr("device_id")), parseInt($(this).attr("begin")), parseInt($(this).attr("end")), $(this).attr("comment"), pos]);
		  });
		  map.push([pos, devices]);
	  });
	  
	  map = map.sort(sortMappingArray);
      
      if (!compareArrays(map, current_deployment.mappings)) {
    	  current_deployment.mappingvis.height(map.length * (MAPPING_BAR_HEIGHT+MAPPING_BAR_SPACER));
  	      
		  if (map.length > current_deployment.bars.length) {
			  var l = current_deployment.bars.length;
			  for (var j = 0; j < map.length-l; j++) {
				  var bar = current_deployment.barPanel.add(pv.Bar);
				  bar.height(MAPPING_BAR_HEIGHT)
			        .cursor(function() {return "help";})
			        .title(function(d) {
			        	var begin = new Date(d[1]).toLocaleString();
			        	var end = "open ended";
			        	if (!isNaN(d[2]))
			        		end = new Date(d[2]).toLocaleString();
			        	var ret = "Device ID " + d[0];
			        	ret += "\nFrom:\t" + begin + "\nTo:\t\t" + end;
			        	if (d[3])
			        		ret += "\nInfo:\t\t" + d[3];
			        	return ret;
			        })
			        .event("mouseover", function(d) {
				  self.status = d[3];
				  if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[d[4]])] !== undefined) {
				    current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[d[4]])].selected = true;
				    current_deployment.node.render();
				  }
				})
			        .event("mouseout", function(d) {
				  self.status = "";
				  if (current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[d[4]])] !== undefined) {
				    current_deployment.sensornodes[nodeindex(current_deployment.positionToDeviceIdMap[d[4]])].selected = false;
				    current_deployment.node.render();
				  }
				})
				    .anchor("center").add(pv.Label)
				      .text(function(d) {return (isNaN(d[2]) || ((x(d[2]) - x(d[1])) > 25)) ? d[0] : "";});

				  current_deployment.bars.push(bar);
			  }
		  }

	      for (var j = 0; j < current_deployment.bars.length; j++) {
	    	  if (j < map.length)
	    	  	current_deployment.bars[j].data(map[j][1])
			      .width(function(d) {
			    	  var d2;
			    	  if (isNaN(d[2]) || d[2] > now+2592000000)
			    		  d2 = now+2592000000;
			    	  else
			    		  d2 = d[2];
			    	  return x(d2) - x(d[1]);
			      })
			      .left(function(d) {return x(d[1]);})
			      .top(j *(MAPPING_BAR_HEIGHT+MAPPING_BAR_SPACER));
	    	  else
	    		  current_deployment.bars[j].data([]);
	      }
	
	    var tD = ((now+2592000000)-positionTimeMin)/6;
		current_deployment.xTicks.left(x)
			.data([positionTimeMin, positionTimeMin+tD, positionTimeMin+tD*2, positionTimeMin+tD*3, positionTimeMin+tD*4, positionTimeMin+tD*5, now+2592000000]);
		
		current_deployment.yTicks.data(map);
		
	    current_deployment.mappings = map;
      }
	
      current_deployment.now.left(function(d) {return x(d);}).data([now]);
      current_deployment.mappingvis.render();
  }
  
  function sortTicksArray(array1, array2){
	 if (array1[0] < array2[0])
		 return -1;
	 else if (array1[0] > array2[0])
		 return 1;
	 else
		 return 0;
  }
  
  function sortMappingArray(array1, array2){
	 if (array1[0] < array2[0])
		 return -1;
	 else if (array1[0] > array2[0])
		 return 1;
	 else
		 return 0;
  }

  function compareArrays(array1, array2) {
      if (!array2)
          return false;

      if (array1.length != array2.length)
          return false;

      for (var i = 0; i < array1.length; i++) {
          if (array1[i] instanceof Array && array2[i] instanceof Array) {
              if (!compareArrays(array1[i], array2[i]))
                  return false;
          }
          else if ((array1[i] != array2[i]) && !(isNaN(array1[i]) && isNaN(array2[i]))) {
              return false;
          }
      }
      return true;
  }

  function generateDateString(d) {
  	var day = d.getDate();
  	if (day < 10) day = "0" + day;
  	var month = d.getMonth()+1;
  	if (month < 10) month = "0" + month;
  	var hours = d.getHours();
  	if (hours < 10) hours = "0" + hours;
  	return day + "." + month + "." + d.getFullYear();
  }
  
  function showNodeInfoTab(id, type, corestationonline) {
    var content = "Type: "+nodetypes[type]+ ((type==5 || type==6)?("<br>Gumstix online: "+corestationonline):"");
    var nodeinfo = $("#topology_"+current_deployment.name+" .nodeinfo");
    if (current_deployment.deploymentHasMapping) {
      if (current_deployment.deviceIdMapping[id] !== undefined) {
	var pos = current_deployment.deviceIdMapping[id].position;
	nodeinfo.find(".title").empty().append("Position: "+pos);
	content += "<br>Device Id: " + id + "<br><br>Info:<br><div style=\"margin:0 5px 5px 5px\">" + current_deployment.deviceIdMapping[id].comment + "</div>";
	if (current_deployment.deviceIdMapping[id].schedule !== undefined)
	  content += "<br>Schedule (cron like job scheduling in UTC):<br><div style=\"background-color:#eee;max-width:942px;max-height:250px;overflow:auto;white-space:nowrap;margin:0 5px 5px 5px;padding:2px 2px 2px 2px\">" + current_deployment.deviceIdMapping[id].schedule.replace(/(\r\n|\n|\r)/gm,"<br>") + "</div>";
	if (current_deployment.deviceIdMapping[id].configuration !== undefined)
	  content += "<br>BackLog configuration file:<br><div style=\"background-color:#eee;max-width:942px;max-height:250px;overflow:auto;white-space:nowrap;margin:0 5px 5px 5px;padding:2px 2px 2px 2px\">" + current_deployment.deviceIdMapping[id].configuration.replace(/(\r\n|\n|\r)/gm,"<br>") + "</div>";
	if (current_deployment.deviceIdMapping[id].jpeg_timestamp !== undefined)
	  content += "<br>Last picture ("+formatTime(current_deployment.deviceIdMapping[id].jpeg_timestamp)+"):<br><div><img style=\"margin:0 5px 5px 5px;border:solid 1px #222;\" src=\"/field?vs="+current_deployment.name+"_camera_pos"+pos+"__scaled&pk=latest&field=JPEG_SCALED&?"+current_deployment.deviceIdMapping[id].jpeg_timestamp+"\"></div>";
        if (current_deployment.deviceIdMapping[id].wgps_schedule !== undefined)
          content += current_deployment.deviceIdMapping[id].wgps_schedule;
      }
      else {
	nodeinfo.find(".title").empty().append("Position: NOT AVAILABLE");
	content += "<br>Device Id: " + id;
      }
    }
    else 
      nodeinfo.find(".title").empty().append("Node ID: "+id);
    
    nodeinfo.find(".infocontainer").empty().append(content);
    nodeinfo.show();
  }
  
  function getGeoMarkerIcon(deviceType) {
  	var ret = geoMarkersTypeToIconMap[deviceType];
  	if (ret === undefined)
  		ret = defaultGeoMarkerIcon;
        return ret;
  }

$(document).ready(function() {
  $.get('/menu.jsp', {selected: "topology"}, function(data) {
    $('#navigation').html(data);
  }, 'html');
  $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

  // load deployments
  $.ajax({
    type: "GET",
    url: "/gsn?structure",
    success: function(data){
      if ($(document).attr("title")=="GSN") {
        var gsn = $("gsn",data);
        $(document).attr("title",$(gsn).attr("name"));
        $("#gsn-name").empty().append($(gsn).attr("name"));
        $("#gsn-desc").empty().append($(gsn).attr("description"));
        $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
        var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
        $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
      }
      $("#gsn-name").show();
      uptime.setTime($(gsn).attr("uptime"));
      var topology_vs_name = new Array();
      var deploymentHasMapping = new Array();
      var arraySize = 0;
      $("virtual-sensor",data).each(function(){
        var deploymentname = $(this).attr("name").split("_", 1)[0];
        var groupname = $(this).attr("name").split("_", 2)[1];
        deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
        if(deploymentname.length > 1 && deploymentname!='Statistics') {
          if ($.inArray(deploymentname, deployments) < 0)
            deployments.push(deploymentname);
          if (groupname == "topology") {
            var i = $.inArray(deploymentname, deployments);
              if (i>-1)
                topology_vs_name[i]=$(this).attr("name");
          }
          if (groupname == "mapping" && $(this).attr("name").split("_", 3)[2] == "chart") {
              var i = $.inArray(deploymentname, deployments);
                if (i>-1)
                	deploymentHasMapping[i]=true;
          }
        }                    
      });
      // display
      var visible;
      if ($.inArray($.cookie("deployment"), deployments)>-1)
        visible = $.cookie("deployment");
      else
        visible = deployments[0];
      for (var i in deployments) {
        // add tab
        $("#deployment_menu").append($.LI({}, $.A({
          "id":"deployment_menu_item_"+deployments[i],
          "href":"javascript:showTopology("+i+")"
          },deployments[i])));
        // add div
        if (deploymentHasMapping[i])
	        $("#topologycontainer").append("<div style=\"position:relative\" id=\"topology_"+deployments[i]+"\"><div style=\"position:absolute;text-align:left\" class=\"statusbar\"></div>"+
	            "<div style=\"position:absolute;z-index:100;margin-top:60px;text-align:left;background-color:#ddd;border:solid 1px #222;display:none\" class=\"nodeinfo\">"+
	            "<div style=\"height:19px;background-color:#aaa\"><span style=\"font-weight:bold\" class=\"title\"></span><img style=\"float:right;margin-right:2px;\" src=\"img/button_cancel.png\"/></div><div style=\"font-color:#000\" class=\"infocontainer\"></div></div>"+
	            "<div id=\"topology_graph_"+deployments[i]+"\"></div>"+
	            "<ul class=\"tabnav\" style=\"padding-bottom:0px;margin-top:10px\"><li><a class =\"active healthtab\" href=\"\">Health</a></li><li><a class =\"geotab\" href=\"\">Map</a></li><li><a class =\"posmappingtab\" href=\"\">Position Mapping</a></li><li><a class =\"configtab\" href=\"\">Configuration</a></li></ul>"+
	            "<div class=\"healthtable\"></div><div id=\"geo_graph_"+deployments[i]+"\" style=\"display:none; width:100%; height:500px\"></div><div id=\"mapping_graph_"+deployments[i]+"\" style=\"display:none\"></div><div class=\"configtable\" style=\"display:none\"></div></div>");
        else
	        $("#topologycontainer").append("<div style=\"position:relative\" id=\"topology_"+deployments[i]+"\"><div style=\"position:absolute;text-align:left\" class=\"statusbar\"></div>"+
				"<div style=\"position:absolute;z-index:100;margin-top:60px;text-align:left;background-color:#ddd;border:solid 1px #222;display:none\" class=\"nodeinfo\">"+
				"<div style=\"height:19px;background-color:#aaa\"><span style=\"font-weight:bold\" class=\"title\"></span><img style=\"float:right;margin-right:2px;\" src=\"img/button_cancel.png\"/></div><div style=\"font-color:#000\" class=\"infocontainer\"></div></div>"+
				"<div id=\"topology_graph_"+deployments[i]+"\"></div>"+
				"<ul class=\"tabnav\" style=\"padding-top:0px\"><li><a class =\"active healthtab\" href=\"\">Health</a></li><li><a class =\"configtab\" href=\"\">Configuration</a></li></ul>"+
				"<div class=\"healthtable\"></div><div class=\"configtable\" style=\"display:none\"></div></div>");
        //$("#topology_"+deployments[i]+" .nodeinfo").show();
        $("#topology_"+deployments[i]+" .nodeinfo img").bind("click", function() { $(this).parent().parent().hide();});
        if (deployments[i]!=visible)
          $("#topology_"+deployments[i]).hide();
        else
          $("#deployment_menu_item_"+deployments[i]).addClass("selected");
        
        // add graph
        deployment_data.push({
          name : deployments[i],
          topology_vs_name : topology_vs_name[i],
          sensornodes : new Array(),
          links : new Array(),
          isTopologyUpdating : false,
          deploymentHasMapping : deploymentHasMapping[i],
          packethistory : new PacketRate(),
          vis : new pv.Panel()
            .width(700)
            .height(300)
            .fillStyle("white")
            .canvas("topology_graph_"+deployments[i]),
          mappingvis: new pv.Panel()
            .fillStyle("white")
            .top(17)
            .bottom(20)
            .left(30)
            .canvas("mapping_graph_"+deployments[i]),
          barPanel : undefined,
          xTicks : undefined,
          yTicks : undefined,
          now : undefined,
          bars : new Array(),
          mappings : new Array(),
          geoMap : deploymentHasMapping[i] ? new google.maps.Map(document.getElementById("geo_graph_"+deployments[i]), {zoom: 18, tilt: 0, mapTypeId: google.maps.MapTypeId.SATELLITE}) : undefined,
          geoMarkers : new Object(),
          geoLinks : new Array(),
          deviceIdMapping : new Object(),
          positionToDeviceIdMap : new Object()
        });
        
        deployment_data[deployment_data.length-1].barPanel = deployment_data[deployment_data.length-1].mappingvis.add(pv.Panel)
        
        deployment_data[deployment_data.length-1].now = deployment_data[deployment_data.length-1].mappingvis.add(pv.Rule);
        deployment_data[deployment_data.length-1].now
		    .top(-3)
		    .bottom(5)
	  	    .strokeStyle("#F00")
	  	  .anchor("top").add(pv.Label)
	  	  	.textStyle("#F00")
		    .text("now");

        deployment_data[deployment_data.length-1].xTicks = deployment_data[deployment_data.length-1].mappingvis.add(pv.Rule);
        deployment_data[deployment_data.length-1].xTicks
		    .bottom(0)
		    .height(5)
	  	    .strokeStyle("#000")
	  	  .anchor("bottom").add(pv.Label)
		    .text(function(d) {return generateDateString(new Date(d));});

        deployment_data[deployment_data.length-1].yTicks = deployment_data[deployment_data.length-1].mappingvis.add(pv.Bar);
        deployment_data[deployment_data.length-1].yTicks
    	    .height(MAPPING_BAR_HEIGHT)
    	    .top(function(d) {return this.index * (MAPPING_BAR_HEIGHT + MAPPING_BAR_SPACER);})
    	    .width(0)
    	    .left(0)
    	  .anchor("left").add(pv.Label)
    	    .textMargin(5)
    	    .textAlign("right")
    	    .text(function(d) {return d[0];});
        
        deployment_data[deployment_data.length-1].force =
          deployment_data[deployment_data.length-1].vis
            .add(pv.Layout.Force)
            .springLength(70)
            .bound(true)
            .chargeConstant(-200)
            .springConstant(.4)
            .link.add(pv.Line).parent.add(pv.Label)
            .text(function(d) {
              return d.srcrssi;
            })
            .left(function(l) {
              var x = l.targetNode.px - l.sourceNode.px;
              var y = l.targetNode.py - l.sourceNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.sourceNode.px + x * f-12;
            })
            .top(function(l) {
              var x = l.targetNode.px - l.sourceNode.px;
              var y = l.targetNode.py - l.sourceNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.sourceNode.py + y * f+8;
            })
            .parent.add(pv.Label)
            .text(function(d) {
              return d.dstrssi;
            })
            .left(function(l) {
              var x = l.sourceNode.px - l.targetNode.px;
              var y = l.sourceNode.py - l.targetNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.targetNode.px + x * f-12;
            })
            .top(function(l) {
              var x = l.sourceNode.px - l.targetNode.px;
              var y = l.sourceNode.py - l.targetNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.targetNode.py + y * f+8;
            })
            .parent.parent;
        deployment_data[deployment_data.length-1].node =
          deployment_data[deployment_data.length-1].force
            .node.add(pv.Dot)
            .shape(function(d) { return d.iscorestation?"square":"circle"; })
            .shapeSize(function(d) {return 230;})
            .fillStyle(function(d) {
              var now=new Date().getTime();
              if (d.timestamp === undefined || (now - d.timestamp) > STANDBY_TIMEOUT_MS) {
		if (d.online) {
		  d.online = false;
		  if (current_deployment.deploymentHasMapping && current_deployment.deviceIdMapping[d.node_id] !== undefined && current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position] !== undefined)
		    current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).offlinesmall);
		}
                return d.selected?"#ff5555":"#ffa0a0";
              }
              else if (now - d.timestamp > ACTIVE_TIMEOUT_MS) {
		if (!d.online) {
		  d.online = true;
		  if (current_deployment.deploymentHasMapping && current_deployment.deviceIdMapping[d.node_id] !== undefined && current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position] !== undefined)
		    current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).small);
		}
		return d.selected?"#1ae01a":"#a0c0a0";
	      }
              else {
		if (!d.online) {
		  d.online = true;
		  if (current_deployment.deploymentHasMapping && current_deployment.deviceIdMapping[d.node_id] !== undefined && current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position] !== undefined)
		    current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).small);
		}
		return d.selected?"#1ae01a":"#a0ffa0";
	      }
            })
            .strokeStyle(function() {return this.fillStyle().darker()})
            .lineWidth(function(d) { return d.corestation_online=="true"?5:1; })
	    .cursor(function() {return "pointer";})
	    .title(function(d) {
	      var content = "";
	      if (current_deployment.deploymentHasMapping) {
		if (current_deployment.deviceIdMapping[d.node_id] !== undefined)
		  content = "Position: "+current_deployment.deviceIdMapping[d.node_id].position + "\n\nType: "+nodetypes[d.nodetype]+ ((d.nodetype==5 || d.nodetype==6)?("\nGumstix online: "+d.corestation_online):"") + "\nDevice Id: " + d.node_id + "\n\nInfo:\n" + current_deployment.deviceIdMapping[d.node_id].comment;
		else
		  content = "Position: NOT AVAILABLE" + "\n\nType: "+nodetypes[d.nodetype]+ ((d.nodetype==5 || d.nodetype==6)?("\nGumstix online: "+d.corestation_online):"") + "\nDevice Id: " + d.node_id;
	      }
	      else 
		content = "Node ID: " + d.node_id + "\n\nType: "+nodetypes[d.nodetype]+ ((d.nodetype==5 || d.nodetype==6)?("\nGumstix online: "+d.corestation_online):"");
	      return content;
	    })
            .event("mouseover", function(d) {
              if (current_deployment.deploymentHasMapping && $("#geo_graph_"+current_deployment.name).is(":visible") && current_deployment.deviceIdMapping[d.node_id] !== undefined && current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position] !== undefined) {
		if (current_deployment.sensornodes[nodeindex(d.node_id)].online)
		  current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).big);
		else
		  current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).offlinebig);
		//current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon({path : google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, strokeWeight: 1, strokeColor: "red", fillColor : "red", fillOpacity : 1, scale : 8});
		current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
	      }
	      d.selected = true;
	      this.render();
	    })
            .event("mouseout", function(d) {
              if (current_deployment.deploymentHasMapping && $("#geo_graph_"+current_deployment.name).is(":visible") && current_deployment.deviceIdMapping[d.node_id] !== undefined && current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position] !== undefined) {
		if (current_deployment.sensornodes[nodeindex(d.node_id)].online)
		  current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).small);
		else
		  current_deployment.geoMarkers[current_deployment.deviceIdMapping[d.node_id].position].setIcon(getGeoMarkerIcon(current_deployment.deviceIdMapping[d.node_id].type).offlinesmall);
	      }
	      d.selected = false;
	      this.render();
	    })
            .event("click", function(d) {
	      showNodeInfoTab(d.node_id, d.nodetype, d.corestation_online);
            }); /*
            .event("mousedown", pv.Behavior.drag())
            .event("drag", deployment_data[deployment_data.length-1].force);*/
        deployment_data[deployment_data.length-1].force
          .label.add(pv.Label)
          .text(function(d) {
	    if (current_deployment.deploymentHasMapping) {
	      if (current_deployment.deviceIdMapping[d.node_id] !== undefined)
		return current_deployment.deviceIdMapping[d.node_id].position;
	      else
		return "?";
	    }
	    else
	      return d.node_id;
	  })
          .font(function() {return "bold 11px sans-serif";});
        // add parser for sorting
        $.tablesorter.addParser({ 
          // set a unique id 
          id: 'checkbox', 
          is: function(s) { 
            // return false so this parser is not auto detected 
            return false; 
          }, 
          format: function(s) { 
            // format your data for normalization 
            if (s.length==0)
              return 0;
            else if (s.indexOf("checked")==-1)
              return 1;
            else
              return 2;
          }, 
          // set type, either numeric or text 
          type: 'numeric' 
        }); 
        // add health table
        $($(".healthtable", "#topology_"+deployments[i])[0]).append("<table class=\"tablesorter\" border=\"0\" cellpadding=\"0\" cellspacing=\"1\"><thead><tr>"+
            "<th class=\"header\" style=\"display:none\">Position</th>"+
            "<th class=\"header\" style=\"width:30px\">ID</th>"+
            "<th class=\"header\">Packet<br>Count</th>"+
            "<th class=\"header\">Vsys</th>"+
            "<th class=\"header\" style=\"width:37px\">Vsdi</th>"+
            "<th class=\"header\" style=\"width:15px\">I</th>"+
            "<th class=\"header\" style=\"width:43px\">Temp</th>"+
            "<th class=\"header\" style=\"width:39px\">Hum</th>"+
            "<th class=\"header\">DB<br>entries</th>"+
            "<th class=\"header\">Flash<br>Count</th>"+
            "<th class=\"header\">Uptime</th>"+
            "<th class=\"header\">Generation Time</th>"+
            "<th class=\"header\">Timestamp</th>"+
            "<th class=\"header\">Packet<br>rate</th>"+
            "</tr></thead><tbody></tbody></table>");
        $("#topology_"+deployments[i]).find(".healthtable table").tablesorter({ 
          widthFixed: true,
          headers:
            { 
              0: { sorter: 'digit' },
              1: { sorter: 'digit' },
              2: { sorter: 'digit' },
              3: { sorter: 'digit' },
              4: { sorter: 'digit' },
              5: { sorter: 'digit' },
              6: { sorter: 'digit' },
              7: { sorter: 'digit' },
              8: { sorter: 'digit' },
              9: { sorter: 'digit' },
              12: { sorter: 'digit' }
            } 
        });
        // add config table
        $($(".configtable", "#topology_"+deployments[i])[0]).append("<table class=\"tablesorter\" border=\"0\" cellpadding=\"0\" cellspacing=\"1\"><thead><tr>"+
            "<th class=\"header\" style=\"display:none\">Posi<br>tion<br></th>"+
            "<th class=\"header\" style=\"width:30px\">ID<br></th>"+
            "<th class=\"header\" style=\"width:33px\">info</th>"+
            "<th class=\"header\">hea<br>lth</th>"+
            "<th class=\"header\">adc<br>mux</th>"+
            "<th class=\"header\">adcco<br>mdiff</th>"+
            "<th class=\"header\" style=\"width:29px\">dcx</th>"+
            "<th class=\"header\" style=\"width:35px\">drift</th>"+
            "<th class=\"header\">ev<br>ents</th>"+
            "<th class=\"header\" style=\"width:35px\">rssi</th>"+
            "<th class=\"header\">state<br>cnt</th>"+
            "<th class=\"header\">deca<br>gon</th>"+
            "<th class=\"header\">vai<br>sala</th>"+
            "<th class=\"header\" style=\"width:29px\">th3</th>"+
            "<th class=\"header\">enviro<br>scan</th>"+
            "<th class=\"header\">mod<br>bus</th>"+
            "<th class=\"header\" style=\"width:42px\">wgps</th>"+
            "<th class=\"header\">power<br>switch</th>"+
            "<th class=\"header\" style=\"width:25px\">p1</th>"+
            "<th class=\"header\" style=\"width:25px\">p2</th>"+
            "<th class=\"header\">Timestamp</th>"+
            "</tr></thead><tbody></tbody></table>");
        $("#topology_"+deployments[i]).find(".configtable table").tablesorter({ 
          widthFixed: true,
          headers:
            { 
              0: { sorter: 'digit' },
              1: { sorter: 'digit' },
              2: { sorter: 'checkbox' },
              3: { sorter: 'checkbox' },
              4: { sorter: 'checkbox' },
              5: { sorter: 'checkbox' },
              6: { sorter: 'checkbox' },
              7: { sorter: 'checkbox' },
              8: { sorter: 'checkbox' },
              9: { sorter: 'checkbox' },
              10: { sorter: 'checkbox' },
              11: { sorter: 'checkbox' },
              12: { sorter: 'checkbox' },
              13: { sorter: 'checkbox' },
              14: { sorter: 'checkbox' },
              15: { sorter: 'checkbox' },
              16: { sorter: 'checkbox' },
              17: { sorter: 'checkbox' }
            } 
        });
        // add status bar
        if (deployments[i]==visible) {
          selected_deployment=deployment_data[i];
          current_deployment=deployment_data[deployment_data.length-1];
          current_deployment.force.nodes(current_deployment.sensornodes);
          current_deployment.force.links(current_deployment.links)
          current_deployment.vis.render();
        }
        // bind tabs
        $("#topology_"+deployments[i]).find(".configtab").click(function() {
          var thiscontainer = $(this).parent().parent().parent();
          thiscontainer.find(".configtable").show();
          thiscontainer.find(".healthtable").hide();
          thiscontainer.find("#mapping_graph_"+current_deployment.name).hide();
          thiscontainer.find("#geo_graph_"+current_deployment.name).hide();
          $(this).addClass("active");
          thiscontainer.find(".healthtab").removeClass("active");
          thiscontainer.find(".posmappingtab").removeClass("active");
          thiscontainer.find(".geotab").removeClass("active");
          return false;
        });
        $("#topology_"+deployments[i]).find(".healthtab").click(function() {
          var thiscontainer = $(this).parent().parent().parent();
          thiscontainer.find(".healthtable").show();
          thiscontainer.find(".configtable").hide();
          thiscontainer.find("#mapping_graph_"+current_deployment.name).hide();
          thiscontainer.find("#geo_graph_"+current_deployment.name).hide();
          $(this).addClass("active");
          thiscontainer.find(".configtab").removeClass("active");
          thiscontainer.find(".posmappingtab").removeClass("active");
          thiscontainer.find(".geotab").removeClass("active");
          resetconfigurations(false);
          return false;
        });
        $("#topology_"+deployments[i]).find(".posmappingtab").click(function() {
          var thiscontainer = $(this).parent().parent().parent();
          thiscontainer.find("#mapping_graph_"+current_deployment.name).show();
          thiscontainer.find(".configtable").hide();
          thiscontainer.find(".healthtable").hide();
          thiscontainer.find("#geo_graph_"+current_deployment.name).hide();
          $(this).addClass("active");
          thiscontainer.find(".healthtab").removeClass("active");
          thiscontainer.find(".configtab").removeClass("active");
          thiscontainer.find(".geotab").removeClass("active");
	  if (!current_deployment.isTopologyUpdating) {
	    clearTimeout(topologyUpdateTimer);
	    if (current_deployment.name !== selected_deployment.name)
	      deviceInfoUpdateIndex = 0;
	    current_deployment = selected_deployment;
	    topologyUpdateTimer = setTimeout("fetchMappingInfo()",200);
	  }
          return false;
        });
        $("#topology_"+deployments[i]).find(".geotab").click(function() {
	  var thiscontainer = $(this).parent().parent().parent();
	  thiscontainer.find("#geo_graph_"+current_deployment.name).show();
	  thiscontainer.find(".configtable").hide();
	  thiscontainer.find(".healthtable").hide();
	  thiscontainer.find("#mapping_graph_"+current_deployment.name).hide();
	  $(this).addClass("active");
	  thiscontainer.find(".healthtab").removeClass("active");
	  thiscontainer.find(".configtab").removeClass("active");
	  thiscontainer.find(".posmappingtab").removeClass("active");
	  google.maps.event.trigger(current_deployment.geoMap, 'resize');
	  if (!current_deployment.isTopologyUpdating) {
	    clearTimeout(topologyUpdateTimer);
	    if (current_deployment.name !== selected_deployment.name)
	      deviceInfoUpdateIndex = 0;
	    current_deployment = selected_deployment;
	    topologyUpdateTimer = setTimeout("fetchMappingInfo()",200);
	  }
	  return false;
	});
      }
      topologyUpdateTimer = setTimeout("fetchMappingInfo()",200);
    }
  });
});

function showTopology(id) {
  for (var i in deployments) {
    $("#topology_"+deployments[i]).hide();
    $("#deployment_menu_item_"+deployments[i]).removeClass("selected");
  }
  $("#topology_"+deployments[id]).show();
  $("#deployment_menu_item_"+deployments[id]).addClass("selected");
  $.cookie("deployment" , deployments[id]);
  selected_deployment = deployment_data[id];
  if (!current_deployment.isTopologyUpdating) {
    clearTimeout(topologyUpdateTimer);
    unmarkNewData();
    current_deployment = selected_deployment;
    deviceInfoUpdateIndex = 0;
    topologyUpdateTimer = setTimeout("fetchMappingInfo()",200);
  }
}
//]]>-->
</script>
</head>
<body>

	<div id="container">
		<div id="header">
			<h1>
				<a href="." id="gsn-name" style="display: none">GSN</a>
			</h1>
			<div id="breadcrumbnav"><a href="http://www.permasense.ch">PermaSense</a> > <a href="." id="gsn-name">GSN</a> > Network Topology</div>
		</div>
		<div id="navigation"></div>

		<div id="maindiv">
			<div id="msg" style="display: none"></div>
			<iframe name="webupload" style="border: 0; height: 0; width: 0;"></iframe>
			<div id="deployment_navigation">
				<ul id="deployment_menu">
					<li />
				</ul>
			</div>
			<div id="topologycontainer" style="margin-top: 5px"></div>
		</div>
		<div class="separator">
			<div id="footer">
				<table width="100%">
					<tr>
						<td style="width: 50%; color: #444444;"><b>A Project of <a
								href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a
								href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a
								href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
						<td style="text-align: right; width: 50%; font-size: 9px;">Powered
							by <a href="http://gsn.sourceforge.net/">GSN</a>, Distributed
							Information Systems Lab, EPFL 2006
						</td>
					</tr>
				</table>
			</div>
		</div>
	</div>
	<div id="debug"></div>
	<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
	<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
