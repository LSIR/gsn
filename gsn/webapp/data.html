<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GSN</title>
        <link rel="stylesheet" href="style/tablesorter.css" type="text/css" media="screen,projection" />
        <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
        <script type="text/javascript" src="js/uptime.js"></script>

        <!-- Visualization -->
        <link rel="stylesheet" type="text/css" href="style/dataplot.css" />
        <link rel="stylesheet" type="text/css" href="style/jquery-ui.custom.min.css" />
        <script type='text/javascript' src='js/jquery-ui.min.js'></script>
        <script type='text/javascript' src='js/dygraph-combined.js'></script>
        <script type='text/javascript' src='js/dygraph-gsn.js'></script>

        <script type="text/javascript">
	    <!--//<![CDATA[
            /* XML object loaded from the REQUEST_LIST_OF_VIRTUAL_SENSORS GSN request */
            var lovs = null;
            /* Mapping from virtual sensor name to list of fields name */
            var virtual_sensor_to_fields = new Object()
            var field_to_virtual_sensor = new Object()

            var plotdata = new Object();
            $(function(){
                function csv_to_json(tag,callback,format){
                    callback = callback || function(){};
                    var old_value = $('#time_format').val();
                    $('#download_format').val('csv');
                    format = format || 'unix';
                    $('#time_format').val(format);
                    prepare_form_for_submission(tag);
                    $.post('/multidata', tag.parents('form').serializeArray(), function(response, text_status, request){
                        var lines = response.split("\n");
                        var headers = [];
                        var timestamp_idx = -1;
                        var vs_name='';
                        var keys =[];
                        var vs = [];
                        var datasets = new Object();
                        for (var line_no=0;line_no<lines.length;line_no++){
                            var line = $.trim(lines[line_no]);
                            if (line.length == 0)
                                continue;

                            if(line[0]=='#'){
                                if (line.indexOf("##vsname:") >= 0){ //comment lines
                                    vs_name = line.substring(9,line.length);
                                    vs.push(vs_name);
                                    keys=[];
                                    headers=[];
                                }
                                if (line[0]== '#' && line[1]!= '#') { //Header
                                    headers = line.split(',');
                                    for (var i=0;i<headers.length;i++){
                                        headers[i] = headers[i].replace("#","");
                                        if (headers[i]==$('.timeline').val()) {
                                            timestamp_idx=i;
                                        } else {
                                            lbl = vs_name+' ('+headers[i]+')';
                                            datasets[lbl]={label: lbl, data: []};
                                            keys.push(lbl);
                                        }
                                    }
                                }
                            }else { // data line, at this stage we should have a header varialbe already set.
                                var data = line.split(',');
                                var timestamp = data[timestamp_idx];
                                for (i=0;i<headers.length;i++){
                                    if(i != timestamp_idx && data[i]!=undefined ){
                                        var key;
                                        if (i>timestamp_idx)
                                        	key = keys[i-1];
                                        else
                                        	key = keys[i];
                                        var d;
                                        if (isNaN(data[i])) {
                                        	if (data[i].slice(0, 10) == '/field?vs=')
                                        		d='<a href="'+data[i]+'">download <img src="style/download_arrow.gif" alt="" /></a>';
                                        	else
                                        		d=data[i];
                                        }
                                        else
                                        	d=parseFloat(data[i]);
                                        if (format == 'unix') {
                                            datasets[key].data.push([parseInt(timestamp),d]);
                                        } else {
                                            datasets[key].data.push([timestamp,d]);
                                        }
                                    }
                                }
                            }
                        }
                        $('#time_format').val(old_value);
                        callback(datasets, vs, keys);
                    });
                }

                function csv_to_dygraph(tag,callback,format){
                    callback = callback || function(){};
                    var old_value = $('#time_format').val();
                    $('#download_format').val('csv');
                    format = format || 'unix';
                    $('#time_format').val(format);
                    prepare_form_for_submission(tag);
                    $.post('/multidata', tag.parents('form').serializeArray(), function(response, text_status, request){
                        var lines = response.split("\n");
                        var headers = [];
                        var timestamp_idx = -1;
                        var vs_name='';
                        var keys =[];
                        var vs = [];
                        var datasets = [];
                        var allkeys = [];
                        var previous_cols = 0;
                        var mintime = -1;
                        var maxtime = -1;
                        var maxdata = 50000;
                        for (var line_no=0;line_no<lines.length;line_no++){
                            var line = $.trim(lines[line_no]);
                            if (line.length == 0)
                                continue;

                            if(line[0]=='#'){
                                if (line.indexOf("##vsname:") >= 0){ //comment lines
                                    vs_name = line.substring(9,line.length);
                                    vs.push(vs_name);
                                    previous_cols = keys.length;
                                    keys=[];
                                    headers=[];
                                }
                                if (line[0]== '#' && line[1]!= '#') { //Header
                                    headers = line.split(',');
                                    for (var i=0;i<headers.length;i++){
                                        headers[i] = headers[i].replace("#","");
                                        if (headers[i]==$('.timeline').val()) {
                                            timestamp_idx=i;
                                        } else {
                                            lbl = vs_name+' ('+headers[i]+')';
                                            keys.push(lbl);
                                            allkeys.push(lbl);
                                        }
                                    }
                                    // add null values to existing datasets
                                    for(var i=0;i<datasets.length;i++) {
                                      for(var j=0;j<keys.length;j++)
                                        datasets[i].push(undefined);
                                    }
                                }
                            }else { // data line, at this stage we should have a header varialbe already set
                                maxdata-=headers.length;
                                if (maxdata < 0) {
                                  break;
                                }               
                                var data = line.split(',');
                                var timestamp = parseInt(data[timestamp_idx]);
                                
                                if (mintime>-1) {
                                  mintime = Math.min(mintime, timestamp);
                                  maxtime = Math.max(maxtime, timestamp);
                                }
                                else {
                                  mintime = timestamp;
                                  maxtime = timestamp;
                                }
                                var row=[timestamp];
                                for(var j=0;j<previous_cols;j++)
                                  row.push(undefined);
                                for (i=0;i<headers.length;i++){
                                    if(i != timestamp_idx ){
                                        var key;
                                        if (i>timestamp_idx)
                                          key = keys[i-1];
                                        else
                                          key = keys[i];
                                        var d;
                                        if (data[i]=='null')
                                          d=data[i];
                                        else
                                          d=parseFloat(data[i]);
                                        row.push(d);
                                    }
                                }
                                datasets.push(row);
                            }
                        }
                        $(".gsn_chart").empty();
                        if (maxdata < 0) {
                          $(".gsn_chart").append("<div id='plotwarning' style='border:2px solid yellow;background-color:#FFFFCC'>Warning: Datapoint number exceeded maximum. Excess data is truncated. Use aggregate functions to watch a longer timeline.<br>"+
                                                 "<form>"+
                                                 "<select id='_agg_function' name='_agg_function'><option value='-1'>No Aggregation</option><option value='avg' selected='selected'>AVG</option><option value='max'>MAX</option><option value='min'>MIN</option></select><input id='_agg_period' name='_agg_period' size='5' type='text' value='2' /><select id='_agg_unit' name='_agg_unit'><option value='3600000'>Hours</option><option value='60000'>Minutes</option><option value='1000'>Seconds</option><option value='1'>Milli Seconds</option></select>"+
                                                 "<input type='button' value='use aggregation'>"+
                                                 "</form></div>");
                        }
                        $("input[type=button]", "#plotwarning").bind('click', function(){ 
                          // copy values to original form
                          $('#agg_function').val($('#_agg_function').val()); $('#agg_function').removeAttr('disabled');
                          $('#agg_period').val($('#_agg_period').val()); $('#agg_period').removeAttr('disabled');
                          $('#agg_unit').val($('#_agg_unit').val()); $('#agg_unit').removeAttr('disabled');
                          // remove this message
                          $(this).unbind('click');
                          $("#plotwarning").remove();
                          // reload plot
                          startplot();                         
                        });
                        $('#time_format').val(old_value);
                        plotdata.labels = allkeys;
                        plotdata.labels.unshift("timeline");
                        plotdata.datasets = datasets;
                        plotdata.mintime = mintime;
                        plotdata.maxtime = maxtime;
                        callback(allkeys);
                    });
                }

                /******************************************************/
                /*                  CHARTING PART DYGRAPH             */
                /******************************************************/                
                function drawChartDy(labels){
                  // element to paint in
                  $(".gsn_chart").append("<div id='dygraph' style=''></div>");
                    var graphconfig = {
                      "graph": {
                      "div" : "dygraph",
                      "type": "dygraph",
                      "width": 900,
                      "height": 350,
                      "showForm": true
                      },
                      "appUrl": "http://vizzly.ethz.ch/vizzly?",
                      "signals": [],
                      loaddata : function(fullReload, signals, start, end, callback) { updatePlot(fullReload, signals, start, end, callback); }
                    };
                    $(labels).each(function(index) {if (index>0) graphconfig.signals.push({
                      "displayName":this,
                      "scaling": 1.0,
                      "deviceSelect": { "type": "ignore" },
                      "visible": this.match(/\(aggregation_interval\)/)?false:true
                    });});
                    new LinePlotWidget(graphconfig);
                }

                function getSortedKeys(obj){
                    var keys = [];
                    for(var key in obj){
                        keys.push(key);
                    }
                    return keys.sort();
                }

                function getSortedValues(obj){
                    var values = [];
                    for(var value in obj){
                        values.push(value);
                    }
                    return values.sort();
                }

                function option_list_key(name,items,all,selected){
                    to_return = '<select name="' + name + '" class="' + name+ '">'
                    if (all){
                        to_return+='<option value="All" >' + all + '</option>';
                    }
                    var sk = getSortedKeys(items);
                    var l = sk.length;
                    for (var i = 0 ; i < l ; i++) {
                        var item = sk[i];
                        if (item == selected)
                          to_return+='<option value="' + item+'" selected="selected">'+item+'</option>';
                        else
                          to_return+='<option value="' + item+'" >'+item+'</option>';
                    }
                    to_return+='</select>'
                    return to_return;
                }

                function option_list_value(name,items,all){
		    		option_list_value(name,items,all, null);
				}

                function option_list_value(name,items,all,selected){
                    to_return = '<select name="' + name + '" class="' + name+ '">'
                    if (all!=null){
                        to_return+='<option value="All" >' + all + '</option>';
                    }
                    var sv = getSortedValues(items);
                    var l = sv.length;
                    for (var i = 0 ; i < l ; i++) {
						var sel = '';
						if (selected != null && items[sv[i]] == selected)
			    			sel = ' selected="selected"';
                        to_return+='<option value="' + items[sv[i]]+'"' +sel+ '>'+items[sv[i]]+'</option>';
                    }
                    to_return+='</select>'
                    return to_return;
                }
                
                function timeline(items) {
				    to_return = new Array();
				    for (var i = 0; i < items.length; i++) {
						if (items[i] == "generation_time" || items[i] == "timestamp") {
						    to_return.push(items[i]);
						}
				    }
				    to_return.sort();
				    to_return.push("timed");
				    return to_return;
                }

                function auto_add_condition(vs) {
                  // add condition for vs if there isn't one
                  var ccount=0;
                  for (var i=0;i<$('#conditions .vss').length;i++) {
                    if ($('#conditions .vss')[i].options[$('#conditions .vss')[i].selectedIndex].value == vs) {
                      ccount++;
                    }
                  }
                  if (ccount == 0)
                    add_condition(vs);
                }

                function auto_remove_condition(vs) {
                  // remove condition if there is no other vs in the data list
                  var vscount = 0;
                  for (var i=0;i<$('#data-outputs .vss').length;i++) {
                    if ($($('#data-outputs .vss')[i]).val() == vs)
                      vscount++;
                  }
                  if (vscount==0) {
                    // remove conditions       
                    $('#conditions .vss').each(function() {
                      if (this.options[this.selectedIndex].value == vs) {
                        $(this).parent().remove();
                      }
                    });
                    $('.join:first').hide();
                  }
                }

                function add_data_output () {
                    var vsscount = $('#data-outputs .vss').length;
                    if (vsscount>0) {
                      var vssselect = $('#data-outputs .vss')[vsscount-1];
                      var last = vssselect.options[vssselect.selectedIndex].value;
                    }
                    if (last!=null && last !="All")
                      $('#data-outputs').append('<li name="'+last+'">' + option_list_key('vss',virtual_sensor_to_fields,"All Virtual Sensors", last) + option_list_value('fields',virtual_sensor_to_fields[last],"All Fields") + ' <a class="remove-criterion" href="#"> Remove</a></li>');
                    else {
                      $('#data-outputs').append('<li name="All">' + option_list_key('vss',virtual_sensor_to_fields,"All Virtual Sensors") + option_list_key('fields',field_to_virtual_sensor,"All Fields") + ' <a class="remove-criterion" href="#"> Remove</a></li>');
                    }
                      
                    $('.vss').change(function(){
                        var vs = $(this).val();
                        if (vs == 'All') {
                            $('.timeline').replaceWith(option_list_value('timeline',["generation_time", "timestamp", "timed"],null,$('.timeline :selected').text()));
                            $(this).next("select").replaceWith(option_list_key('fields',field_to_virtual_sensor,"All Fields"));
                        }
                        else {
                            $('.timeline').replaceWith(option_list_value('timeline',timeline(virtual_sensor_to_fields[vs]),null,$('.timeline :selected').text()));
                            $(this).next("select").replaceWith(option_list_value('fields',virtual_sensor_to_fields[vs],"All Fields"));
                            auto_add_condition(vs);
                        }
                        auto_remove_condition($(this).parent().attr('name'));
                        $(this).parent().attr('name', vs);
                    });
                    $('.remove-criterion').click (function() {
                        var vs = $($(this).parent().find('.vss')[0]).val();
                        $(this).parent().remove();
                        auto_remove_condition(vs);
                        $('.join:first').hide();
                    });
                }

                function add_condition (selected) {
                    if (selected != null)
                      $('#conditions').append('<li><select class="join" name="join"><option value="and">AND</option><option value="or">OR</option></select>' +  option_list_key('vss',virtual_sensor_to_fields,"All Virtual Sensors", selected) + option_list_value('fields',virtual_sensor_to_fields[selected],"All Fields") + ' | Between <input class="min" type="text" size="3" value="-inf" /> and <input class="max" type="text" size="3" value="+inf" /><a class="remove-criterion" href="#"> Remove</a></li>');
                    else
                      $('#conditions').append('<li><select class="join" name="join"><option value="and">AND</option><option value="or">OR</option></select>' +  option_list_key('vss',virtual_sensor_to_fields,"All Virtual Sensors") + option_list_key('fields',field_to_virtual_sensor,"All Fields") + ' | Between <input class="min" type="text" size="3" value="-inf" /> and <input class="max" type="text" size="3" value="+inf" /><a class="remove-criterion" href="#"> Remove</a></li>');
                    $('.vss').change(function(){
                        var vs = $(this).val();
                        if (vs == 'All') {
                            $('.timeline').replaceWith(option_list_value('timeline',["generation_time", "timestamp", "timed"],null,$('.timeline :selected').text()));
                            $(this).next("select").replaceWith(option_list_key('fields',field_to_virtual_sensor,"All Fields"));
                        }
                        else {
                            $('.timeline').replaceWith(option_list_value('timeline',timeline(virtual_sensor_to_fields[vs]),null,$('.timeline :selected').text()));
                            $(this).next("select").replaceWith(option_list_value('fields',virtual_sensor_to_fields[vs],"All Fields"));
                        }
                    });
                    $('.remove-criterion').click (function() {
                        $(this).parent().remove();
                        $('.join:first').hide();
                    });
                    $('.join:first').hide();
                }

                function prepare_form_for_submission(tag){
                    var counter = 0;
                    tag.parents('form').find('.data-outputs-container li').each(function(){
                        $(this).find('.vss').each(function(){$(this).attr('name','vs['+counter+']');});
                        $(this).find('.fields').each(function(){$(this).attr('name','field['+counter+']');});
                        counter++;
                    });
                    counter = 0;
                    tag.parents('form').find('.conditions-container li').each(function(){
                        $(this).find('.vss').each(function(){$(this).attr('name','c_vs['+counter+']');});
                        $(this).find('.fields').each(function(){$(this).attr('name','c_field['+counter+']');});
                        $(this).find('.join').each(function(){$(this).attr('name','c_join['+counter+']');});
                        $(this).find('.max').each(function(){$(this).attr('name','c_max['+counter+']');});
                        $(this).find('.min').each(function(){$(this).attr('name','c_min['+counter+']');});
                        counter++;
                    });
                }

                function customRange(input) {
                    return {minDate: (input.id == "datepicker_to" ? $("#datepicker_from").datepicker("getDate") : null),
                        maxDate: (input.id == "datepicker_from" ? $("#datepicker_to").datepicker("getDate") : null)};
                }

                /** Load the REQUEST_LIST_OF_VIRTUAL_SENSORS xml and create the mapping */
                $.get("/gsn?REQUEST=0&structure", function(xml){
                    lovs = xml
                    if ($(document).attr("title")=="GSN") {
                      var gsn = $("gsn",xml);
                      $(document).attr("title",$(gsn).attr("name"));
                      $("#gsn-name").empty().append($(gsn).attr("name"));
                      $("#gsn-desc").empty().append($(gsn).attr("description"));
                      $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
                      var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
                      $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
                    }
                    $("#gsn-name").show();
                    uptime.setTime($(gsn).attr("uptime"));
                    
                    $('virtual-sensor',xml).each(function(){
                        var vsname = $(this).attr('name');
                        virtual_sensor_to_fields[vsname] = virtual_sensor_to_fields[vsname] || []
                        $(this).find('field').each(function(){
                            if ($(this).attr('category') != 'predicate') {
                                var field_name = $(this).attr('name');
                                virtual_sensor_to_fields[vsname].push(field_name);
                                field_to_virtual_sensor[field_name] = field_to_virtual_sensor[field_name] || []
                                field_to_virtual_sensor[field_name].push(vsname)
                            }
                        });
                    });
                    add_data_output ();
                    add_condition ();
                });

                $('#add-data-output').click(function () {
                    add_data_output();
                });

                $('#add-condition').click(function () {
                    add_condition();
                });

                $('#nb').change(function(){
                    var val = $(this).val();
                    $('#nb_value').attr('disabled', (val == 'ALL'));
                });

                $('#agg_function').change(function(){
                    $('#agg_period').attr('disabled',$(this).val() == '-1');
                    $('#agg_unit').attr('disabled',$(this).val() == '-1');
                });

                $("#datepicker_from, #datepicker_to").datepicker({beforeShow: customRange, prevText: "", nextText: "", firstDay: 1, showOn: "both",  buttonImage: "/style/calendar.png", buttonImageOnly: true, dateFormat: "dd/mm/yy 00:00:00" });

                $('.download_btn_csv').click(function(){
                    $('#download_format').val('csv');
                    prepare_form_for_submission($(this));
                    return true;
                });

                $('.download_btn_xml').click(function(){
                    $('#download_format').val('xml');
                    prepare_form_for_submission($(this));
                    return true;
                });

                $('.download_btn_pdf').click(function(){
                    $('#download_format').val('pdf');
                    var max_limit = 5000 ;
                    var limit_enabled = $('#nb').val() != 'ALL';
                    var limit = $('#nb_value').val();
                    if (!limit_enabled || limit > max_limit) {
                        $('#nb_value').val(max_limit);
                        $('#nb_value').attr('disabled',false);
                        $('#nb').val('SPECIFIED');
                        alert("The report functionality is limited to " + max_limit + " rows per virtual sensor.");
                    }
                    prepare_form_for_submission($(this));
                    return true;
                });

                function updatePlot(fullReload, signals, start, end, callback/*(fullReload, data)*/) {
                  // data format: csv
                  // labels
                  // # min(unixtime), max(unixtime)
                  // # ERROR: <error message>
                  var ux_start = start?start.getTime():plotdata.mintime;
                  var ux_end = end?end.getTime():plotdata.maxtime;
                  var visibles = [0];
                  $(signals).each(function(index){      
                    if (this.visible==true)
                      visibles.push(index+1);
                  });
                  var csv = "";
                  $(visibles).each(function(index){csv+=(index==0?"":",")+plotdata.labels[this];})
                  csv += "\n# "+plotdata.mintime + ","+plotdata.maxtime+"\n";
                  if (visibles.length==1) {
                    csv+="# ERROR: No data selected.\n";
                  }
                  else {
                    $(plotdata.datasets).each(function() {
                      var row=this;
                      if (row[0]>=ux_start && row[0]<=ux_end) {
                        var d = new Date();
                        var timestamp = new Date(row[0]+d.getTimezoneOffset()*60*1000);
                        $(visibles).each(function(index){
                          if (this==0)
                            csv+=timestamp.getFullYear()+"/"+(timestamp.getMonth()+1)+"/"+timestamp.getDate()+" "+timestamp.getHours()+":"+timestamp.getMinutes()+":" +timestamp.getSeconds();
                          else
                            csv+=','+row[this];
                        });
                        csv+="\n";
                      }
                    });
                  }
                  callback(fullReload, csv);
                }

                function startplot() {
                    plotdata = new Object();
                    $(".gsn_chart").empty().append("<div style='border:2px solid yellow;background-color:#FFFFCC'>Loading data.. <img src='style/ajax-loader.gif' width='16' height='16' alt='loading'></div>");
                    csv_to_dygraph($(".plot"),drawChartDy);
                }

                $(".plot").click(function(){
                  startplot();
                });

                $(".grid").click(function(){
                    function drawGrid(datasets){
                        $("#gridContainer").empty();
                        $("#sensorSelect").show();
                        $("#sensorSelect").empty();
                        $("#sensorSelect").unbind('change');
                        $("#sensorSelect").append('<option value="">Select a Virtual Sensor</option>');
                        var displayed = [];
                        for (var sensor in datasets) {
                            sensor = sensor.split(' ')[0];
                            if ($.inArray(sensor, displayed) < 0) {
                                displayed.push(sensor);
                                option = $("<option value=\"" + sensor + "\">" + sensor + "</option>");
                                $("#sensorSelect").append(option);
                            }
                        }
                        $("#sensorSelect").change(function(){
                            var choice = $("#sensorSelect").val();
                            $('#gridContainer').empty();
                            if (choice == '') return;
                            // columns
                            var fields = [];
                            // column headers
                            var headers = [];
                            for (var sensor_field in datasets) {
                                if (sensor_field.substring(0, choice.length) == choice) {
                                    fields.push(datasets[sensor_field]);
                                    headers.push(sensor_field.substring(choice.length + 2, sensor_field.length - 1));
                                }
                            }
                            var data_length = fields[0]['data'].length;
                            var grid = '<table id="grid" class="tablesorter" border="0" cellpadding="0" cellspacing="1"><thead><tr><th>'+($('.timeline').val())+'</th>';
                            for (var i = 0; i < headers.length; i++) {
                                grid += '<th>' + headers[i] + '</th>';
                            }
                            grid += '</tr></thead><tbody>';
                            for (var i = 0; i < data_length; i++) {
                                // bug with the csv_to_json function: the last row is empty
                                if (fields[0]['data'][i][0]) {
                                    grid += '<tr><td>' + fields[0]['data'][i][0] + '</td>';
                                    for (var j = 0; j < fields.length; j++) {
                                        grid += '<td>' + fields[j]['data'][i][1] + '</td>'
                                    }
                                    grid += '</tr>';
                                }
                            }
                            grid += '</tbody></table>';
                            $('#gridContainer').html(grid);
                            $('#grid').tablesorter({
                                widthFixed: true,
                                widgets: ['zebra']
                            });
                        });
                    }
                    $("#sensorSelect").hide();
                    $("#gridContainer").empty().append("<div style='border:2px solid yellow;background-color:#FFFFCC'>Loading data.. <img src='style/ajax-loader.gif' width='16' height='16' alt='loading'></div>");
                    csv_to_json($(this), drawGrid, 'iso');
                });

                $('.accordion').accordion({
                    header: ".ui-accordion-header",
                    clearStyle: true
                });

                $('.tabs').tabs();

                $('.ui-default-state').hover(
                function(){$(this).addClass('ui-hover-state');},
                function(){$(this).removeClass('ui-hover-state');});

                $.get('/menu.jsp', {selected: "data"}, function(data) {
                    $('#navigation').html(data);
                }, 'html');
            });
	//]]>-->
        </script>
    </head>
    <body>
        <div id="container">
            <div id="header">
                <h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
				<div id="breadcrumbnav"><a href="http://www.permasense.ch">PermaSense</a> > <a href="." id="gsn-name">GSN</a> > Data</div>
            </div>
            <div id="navigation" style="text-align:right;">
            </div>
            <div id="main" class="full-page">
                <noscript><p class="error">Your browser doesn't appear to support JavaScript. This is most likely because you're using a text-based or otherwise non-graphical browser. Sadly, GSN require javascript in order to work properly. If you want to access directly the data, you can use the api at <a href="http://localhost:22001/gsn">http://localhost:22001/gsn</a>.</p></noscript>
                <!-- data part -->
                <br/>
                <div id="datachooser">
                    <div id="data_1" class="clearfix">
                        <form action="/multidata" method="post">
                            <div class="accordion">
                                <div class="ui-accordion-group">
                                    <h3 class="ui-accordion-header"><a href="#">&nbsp;&nbsp;&nbsp;&nbsp;Data Output</a></h3>
                                    <div class="ui-accordion-content">
                                        <div class="aggregations">
                                            <p>
                                                <select id="nb" name="nb"><option value="ALL">All Data</option><option value="SPECIFIED" selected="selected">Only</option></select>
                                                <input id="nb_value" name="nb_value" size="3" type="text" value="10" /><span> Values</span>
                                            </p>
                                            <p>
                                                <span>Aggregation</span>
                                                <select id="agg_function" name="agg_function"><option value="-1">No Aggregation</option><option value="avg">AVG</option><option value="max">MAX</option><option value="min">MIN</option></select><input disabled="disabled" id="agg_period" name="agg_period" size="5" type="text" value="2" /><select disabled="disabled" id="agg_unit" name="agg_unit"><option value="3600000">Hours</option><option value="60000">Minutes</option><option value="1000">Seconds</option><option value="1">Milli Seconds</option></select>
                                            </p>
                                            <p>
                                                <span>Timeline</span>
                                                <select class="timeline" name="timeline"><option value="generation_time">generation_time</option><option value="timestamp">timestamp</option><option value="timed">timed</option></select>
                                            </p>
                                        </div>
                                        <div class="data-outputs-container">
                                            <a id="add-data-output" href="#">Add Output</a>
                                            <ul id="data-outputs"><li /></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui-accordion-group">
                                    <h3 class="ui-accordion-header"><a href="#">&nbsp;&nbsp;&nbsp;&nbsp;Conditions</a></h3>
                                    <div class="ui-accordion-content">
                                        <div class="time-range">
                                            <div>
                                                <br />
                                            <span>From [UTC]</span><input id="datepicker_from" name="from" size="16" type="text" value="" /><span> To [UTC]</span><input id="datepicker_to" name="to" size="16" type="text" value="" /></div>
                                            <br />
                                        </div>
                                        <div class="conditions-container">
                                            <a id="add-condition" href="#">Add Condition</a>
                                            <ul id="conditions"><li /></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui-accordion-group">
                                    <h3 class="ui-accordion-header"><a href="#">&nbsp;&nbsp;&nbsp;&nbsp;Results</a></h3>
                                    <div class="ui-accordion-content" style="padding:0">
                                        <div class="tabs">
                                            <ul>
                                                <li><a href="#fragment-1-1">Download</a></li>
                                                <li><a class="plot" href="#fragment-1-2">Plot</a></li>
                                                <li><a class="grid" href="#fragment-1-3"><span>Table</span></a></li>
                                            </ul>
                                            <div id="fragment-1-1">
                                                <input class="ui-default-state download_btn_csv" name="commit" type="submit" value="Download CSV" />
                                                <input class="ui-default-state download_btn_xml" name="commit" type="submit" value="Download XML" />
                                                <input class="ui-default-state download_btn_pdf" name="commit" type="submit" value="Generate PDF" />
                                                <span>Time Format</span>
                                                <select id="time_format" name="time_format"><option value="iso">ISO 8601</option><option value="unix">UNIX</option></select>
                                                <input id="download_format" type="hidden" name="download_format" value="csv"></input>
                                                <input id="reportclass" type="hidden" name="reportclass" value="report-default"></input>
                                            </div>
                                            <div id="fragment-1-2">
                                                <div class="chart_box">
                                                    <div id="vs_selector" class="dlg_selector" title="Output Selector">
                                                        <div class="gsn_chart" > </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="fragment-1-3">
                                                <select id="sensorSelect">
                                                    <option value="">(none)</option>
                                                </select>
                                                <div id="gridContainer"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
		<div class="separator">
			<div id="footer">
				<table width="100%">
					<tr>
						<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
						<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
					</tr>
				</table>
			</div>
		</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
