<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<title>GSN</title>
	
	<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery-dom.js"></script>
	<script type="text/javascript" src="js/jquery.history.js"></script>
	<script type="text/javascript" src="js/jquery-tooltip.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	
	<!-- the mousewheel plugin - optional to provide mousewheel support -->
	<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

	<!-- the jScrollPane script -->
	<script type="text/javascript" src="js/jquery.jscrollpane.min.js"></script>
	
	<style type="text/css" id="page-css">
		/* Styles specific to this particular page */
		.scroll-pane
		{
			width: 100%;
			height: 600px;
			overflow: auto;
		}
	</style>

    <script type="text/javascript" src="js/uptime.js"></script>

<script type="text/javascript">
<!--//<![CDATA[

var CORESTATION_TYPES = [4, 5, 6];
var LOOK_N_DAYS_BACK = 5;
var MAX_LOGS_PER_REQUEST = 100;
var MAX_LOGS_TOTAL = 1000;
var UPDATE_INTERVAL = 2;

var EVENT_MSG = new Array(
	 "" /* 0: */,
	 "" /* 1: */,
	 "" /* 2: not used EVENT_COMMAND_RECEIVED %s*/,
	 "" /* 3: not used EVENT_EVENT_Q_FULL %s */,
	 "Node resetted, resetcounter is %s." /* 4: EVENT_RESET %s*/,
	 "" /* 5: not used EVENT_WATCHDOG_RESET %s */,
	 "DAQ lasted for too long, last data source was %s." /* 6: EVENT_DAQ_RESET*/,
	 "" /* 7: */,
	 "" /* 8: */,
	 "" /* 9: */,
	 "Dozer: Connected to parent %s." /* 10: EVENT_CHILD_CONNECT %s */,
	 "" /* 11: not used EVENT_CHILD_DISCONNECT %s */,
	 "" /* 12: not used EVENT_CHILD_DISCONNECT_ROUTING_LOOP %s */,
	 "Dozer: No beacon received, failed connection attempts: %s." /* 13: EVENT_CHILD_NO_BEACON %s */,
	 "Dozer: Could not upload data in this round, failed connection attempts: %s." /* 14: EVENT_CHILD_NO_DATAUPLOAD %s */,
	 "" /* 15: not used EVENT_CHILD_RESET_OVERHEARTIME %s */,
	 "Dozer: Found %s potential parents." /* 16: EVENT_CHILD_FOUND_PARENTS %s */,
	 "" /* 17: */,
	 "" /* 18: */,
	 "" /* 19: */,
	 "Dozer: Got connection from child %s." /* 20: EVENT_PARENT_CONNECT %s */,
	 "Dozer: Disconnected child %s." /* 21: EVENT_PARENT_DISCONNECT %s */,
	 "" /* 22: not used EVENT_DOZER_WATCHDOG %s */,
	 "Dozer: Received duplicate from child %s." /* 23: EVENT_PARENT_DUPLICATE %s */,
     "" /* 24: */,
     "" /* 25: */,
     "" /* 26: */,
     "" /* 27: */,
     "" /* 28: */,
     "" /* 29: */,
	 "" /* 30: not used EVENT_BB_POWER_ON %s */,
	 "Baseboard power off, shutdownrequest was %s." /* 31: EVENT_BB_POWER_OFF %s */,
	 "Received power switch command with value %s." /* 32: EVENT_PSB_POWER %s */,
	 "Baseboard: Set new schedule interval to %s seconds." /* 33: EVENT_BB_NEWSCHEDULE %s */,
	 "Baseboard: Set new servicewindow to %s seconds." /* 34: EVENT_BB_NEWSERVICEWINDOW %s */,
	 "" /* 35: not used EVENT_BB_NEWSERVICEWINDOW_INVALID %s*/ ,
	 "Baseboard: Set V12DC_EXT to %s." /* 36: EVENT_BB_V12DC_EXT_SW %s */,
	 "" /* 37: */,
	 "" /* 38: */,
	 "" /* 39: */,
	 "Received datasource config command %s." /* 40: EVENT_DATACONFIG %s*/,
	 "Wxt520 init failed with code %s." /* 41: EVENT_WXT520_INIT_FAIL %s */,
	 "" /* 42: */,
	 "" /* 43: */,
	 "" /* 44: */,
	 "" /* 45: */,
	 "" /* 46: */,
	 "" /* 47: */,
	 "" /* 48: */,
	 "" /* 49: */,
	 "" /* 50: not used EVENT_ERROR_SD_MOUNT %s */,
	 "" /* 51: not used EVENT_ERROR_SD_GENERIC %s */,
	 "" /* 52: */,
	 "" /* 53: */,
	 "" /* 54: */,
	 "" /* 55: */,
	 "" /* 56: */,
	 "" /* 57: */,
	 "" /* 58: */,
	 "" /* 59: */,
	 "" /* 60: not used EVENT_ERROR_RADIO_GENERIC %s */,
	 "SX1211: Radio pattern error %s." /* 61: EVENT_ERROR_RADIO_PATTERN %s" */,
	 "" /* 62: */,
	 "" /* 63: */,
	 "" /* 64: */,
	 "" /* 65: */,
	 "" /* 66: */,
	 "" /* 67: */,
	 "" /* 68: */,
	 "" /* 69: */,
	 "" /* 70: not used EVENT_AE_ARM_POWER_ON %s */,
	 "" /* 71: not used EVENT_AE_ARM_POWER_OFF %s */,
	 "" /* 72: not used EVENT_AE_ARM_RESET %s */,
	 "" /* 73: not used EVENT_AE_ARM_COMM_TIMEOUT %s */,
	 "AE board: set new posttrigger to %s." /* 74: EVENT_AE_POSTTRIGGER_SET %s */,
	 "AE board: set new threshhold to %s." /* 75: EVENT_AE_THRESHOLD_SET %s */, 
	 "" /* 76: not used EVENT_AE_DUPLICATE */,
	 "" /* 77: */,
	 "" /* 78: */,
	 "" /* 79: */,
	 "WGPS: Sam7 reset (Firmware version: %s)." /* 80: EVENT_WGPS_STARTUP */,
	 "WGPS: Sam7 parameters (re-)initialized to default values (ID = %s)." /* 81: EVENT_WGPS_INIT_PARAMS */,
	 "" /* not used 82: EVENT_WGPS_CARD_FULL */,
	 "WGPS: Sam7 last measurement not finished, still busy (Flag = %s)." /* 83: EVENT_WGPS_MEAS_BUSY */,
	 "" /* not used 84: EVENT_WGPS_ENTER_STOP */,
	 "" /* not used 85: EVENT_WGPS_SELFTEST_START */,
	 "WGPS: Sam7 self-test done with exit code %s." /* 86: EVENT_WGPS_SELFTEST_DONE */,
	 "WGPS: Sam7 setting custom configuration failed with error code %s." /* 87: EVENT_WGPS_GPSCUSTOMCFG_FAIL */,
	 "WGPS: Sam7 first valid time received from GPS (GPS week: %s)." /* 88: EVENT_WGPS_FIRST_VALID_TIME */,
	 "" /* not used 89: EVENT_WGPS_GPS_DATALOSS */,
	 "" /* not used 90: EVENT_WGPS_GPS_FAILURE */,
	 "" /* not used 91: EVENT_WGPS_MEAS_FAILURE */,
	 "WGPS: Sam7 card init error with code %s." /* 92: EVENT_WGPS_CARD_INIT_ERROR */,
	 "WGPS: Sam7 status buffer overflow (%s overflows since last readout)." /* 93: EVENT_WGPS_STATUS_OVERFLOW */,
	 "WGPS: Sam7 space vehicle buffer overflow (%s overflows since last readout). " /* 94: EVENT_WGPS_SV_OVERFLOW */,
	 "WGPS: Sam7 event buffer overflow (%s overflows since last readout). " /* 95: EVENT_WGPS_EVENT_OVERFLOW */,
	 "WGPS: Received command is ok (command: %s)." /* 96: EVENT_WGPS_COMMAND_OK */,
	 "WGPS: Received command is erroneous (command: %s)." /* 97: EVENT_WGPS_COMMAND_ERROR */,
	 "WGPS: Modbus communication error (code: %s)." /* 98: EVENT_WGPS_MODBUS_ERROR */,
	 "WGPS: Power state change (new state: %s)." /* 99: EVENT_WGPS_POWER_STATE_CHANGE */,
	 "" /* not used 100: EVENT_WGPS_TIME_SYNC_FAILED */,
	 "" /* not used 101: EVENT_WGPS_GPS_CRC_FAILURE */ );
		 
var EVENT_MSG_NULL = new Array(
	 "" /* 0: */,
	 "" /* 1: */,
	 "" /* 2: not used EVENT_COMMAND_RECEIVED */,
	 "Event queue is full, there could be dropped events." /* 3: EVENT_EVENT_Q_FULL */,
	 "" /* 4: not used EVENT_RESET */,
	 "Node started after watchdog reset." /* 5: EVENT_WATCHDOG_RESET */,
	 "" /* 6: */,
	 "" /* 7: */,
	 "" /* 8: */,
	 "" /* 9: */,
	 "" /* 10: not used EVENT_CHILD_CONNECT */,
	 "Dozer: Disconnected from parent." /* 11: EVENT_CHILD_DISCONNECT */,
	 "Dozer: Disconnected due to routing loop." /* 12: EVENT_CHILD_DISCONNECT_ROUTING_LOOP */,
	 "" /* 13: not used EVENT_CHILD_NO_BEACON */,
	 "" /* 14: not used EVENT_CHILD_NO_DATAUPLOAD */,
	 "Dozer: Reset overhear time." /* 15: EVENT_CHILD_RESET_OVERHEARTIME */,
	 "" /* 16: not used EVENT_CHILD_FOUND_PARENTS */,
	 "" /* 17: */,
	 "" /* 18: */,
	 "" /* 19: */,
	 "" /* 20: not used EVENT_PARENT_CONNECT */,
	 "" /* 21: not used EVENT_PARENT_DISCONNECT */,
	 "Dozer: Watchdog triggered." /* 22: EVENT_DOZER_WATCHDOG */,
	 "" /* 23: not used EVENT_PARENT_DUPLICATE */,
	 "" /* 24: */,
	 "" /* 25: */,
	 "" /* 26: */,
	 "" /* 27: */,
	 "" /* 28: */,
	 "" /* 29: */,
	 "Baseboard power on." /* 30: EVENT_BB_POWER_ON */,
	 "" /* 31: not used EVENT_BB_POWER_OFF */,
	 "" /* 32: not used EVENT_PSB_POWER */,
	 "Baseboard: Received invalid schedule interval." /* 33: EVENT_BB_NEWSCHEDULE */,
	 "Baseboard: Disabled servicewindow." /* 34: EVENT_BB_NEWSERVICEWINDOW*/,
	 "Baseboard: Received invalid servciewindow interval." /* 35: EVENT_BB_NEWSERVICEWINDOW_INVALID */,
	 "" /* 36: not used EVENT_BB_V12DC_EXT_SW */,
	 "" /* 37: */,
	 "" /* 38: */,
	 "" /* 39: */,
	 "" /* 40: not used EVENT_DATACONFIG */,
	 "" /* 41: not used EVENT_WXT520_INIT_FAIL */,
	 "" /* 42: */,
	 "" /* 43: */,
	 "" /* 44: */,
	 "" /* 45: */,
	 "" /* 46: */,
	 "" /* 47: */,
	 "" /* 48: */,
	 "" /* 49: */,
	 "Error while mounting SD card." /* 50: EVENT_ERROR_SD_MOUNT */,
	 "Generic SD card error." /* 51: EVENT_ERROR_SD_GENERIC */,
	 "" /* 52: */,
	 "" /* 53: */,
	 "" /* 54: */,
	 "" /* 55: */,
	 "" /* 56: */,
	 "" /* 57: */,
	 "" /* 58: */,
	 "" /* 59: */,
	 "" /* 60: not used EVENT_ERROR_RADIO_GENERIC*/,
	 "" /* 61: not used EVENT_ERROR_RADIO_PATTERN*/,
	 "" /* 62: */,
	 "" /* 63: */,
	 "" /* 64: */,
	 "" /* 65: */,
	 "" /* 66: */,
	 "" /* 67: */,
	 "" /* 68: */,
	 "" /* 69: */,
	 "AE board: ARM power on." /* 70: EVENT_AE_ARM_POWER_ON */,
	 "AE board: ARM power off." /* 71: EVENT_AE_ARM_POWER_OFF */,
	 "AE board: ARM reset." /* 72: EVENT_AE_ARM_RESET */,
	 "AE board: Communication to ARM timed out." /* 73: EVENT_AE_ARM_COMM_TIMEOUT */,
	 "" /* 74: not used EVENT_AE_POSTTRIGGER_SET */,
	 "" /* 75: not used EVENT_AE_THRESHOLD_SET */, 
     "AE board: Received duplicate" /* 76: EVENT_AE_DUPLICATE */,
	 "" /* 77: */,
	 "" /* 78: */,
	 "" /* 79: */,
	 "" /* 80: not used EVENT_WGPS_STARTUP */,
	 "" /* 81: not used EVENT_WGPS_INIT_PARAMS */,
	 "WGPS: Sam7 SD card full -> stopped logging to card." /* 82: EVENT_WGPS_CARD_FULL */,
	 "" /* 83: not used EVENT_WGPS_MEAS_BUSY */,
	 "WGPS: Enter stop mode." /* 84: EVENT_WGPS_ENTER_STOP */,
	 "WGPS: Start self-test." /* 85: EVENT_WGPS_SELFTEST_START */,
	 "" /* 86: not used EVENT_WGPS_SELFTEST_DONE */,
	 "" /* 87: not used EVENT_WGPS_GPSCUSTOMCFG_FAIL */,
	 "" /* 88: not used EVENT_WGPS_FIRST_VALID_TIME */,
	 "WGPS: GPS data lost (message lock broken)." /* 89: EVENT_WGPS_GPS_DATALOSS */,
	 "WGPS: Fatal GPS failure." /* 90: EVENT_WGPS_GPS_FAILURE */,
	 "WGPS: Fatal measurement failure." /* 90: EVENT_WGPS_MEAS_FAILURE */,
	 "" /* 92: not used EVENT_WGPS_CARD_INIT_ERROR */,
	 "" /* 93: not used EVENT_WGPS_STATUS_OVERFLOW */,
	 "" /* 94: not used EVENT_WGPS_SV_OVERFLOW */,
	 "" /* 95: not used EVENT_WGPS_EVENT_OVERFLOW */,
	 "" /* 96: not used EVENT_WGPS_COMMAND_OK */,
	 "" /* 97: not used EVENT_WGPS_COMMAND_ERROR */,
	 "" /* 98: not used EVENT_WGPS_MODBUS_ERROR */,
	 "" /* 99: not used EVENT_WGPS_POWER_STATE_CHANGE */,
	 "WGPS: Time synchronization with Sam7 at start-up failed" /* 100: EVENT_WGPS_TIME_SYNC_FAILED */,
	 "WGPS: GPS checksum match failure detected on Sam7" /* 101: EVENT_WGPS_GPS_CRC_FAILURE */ );
		
var EVENT_MSG_ERRORLEVELS = new Array(
	 6 /* 0: */,
	 6 /* 1: */,
	 6 /* 2: EVENT_COMMAND_RECEIVED */,
	 4 /* 3: EVENT_EVENT_Q_FULL */,
	 4 /* 4: EVENT_RESET */,
	 3 /* 5: EVENT_WATCHDOG_RESET */,
	 3 /* 6: */,
	 6 /* 7: */,
	 6 /* 8: */,
	 6 /* 9: */,
	 6 /* 10: EVENT_CHILD_CONNECT */,
	 6 /* 11: EVENT_CHILD_DISCONNECT */,
	 6 /* 12: EVENT_CHILD_DISCONNECT_ROUTING_LOOP */,
	 6 /* 13: EVENT_CHILD_NO_BEACON */,
	 6 /* 14: EVENT_CHILD_NO_DATAUPLOAD */,
	 6 /* 15: EVENT_CHILD_RESET_OVERHEARTIME */,
	 6 /* 16: EVENT_CHILD_FOUND_PARENTS */,
	 6 /* 17: */,
	 6 /* 18: */,
	 6 /* 19: */,
	 6 /* 20: EVENT_PARENT_CONNECT */,
	 6 /* 21: EVENT_PARENT_DISCONNECT */,
	 3 /* 22: EVENT_DOZER_WATCHDOG */,
	 6 /* 23: EVENT_PARENT_DUPLICATE */,
	 6 /* 24: */,
	 6 /* 25: */,
	 6 /* 26: */,
	 6 /* 27: */,
	 6 /* 28: */,
	 6 /* 29: */,
	 6 /* 30: EVENT_BB_POWER_ON */,
	 6 /* 31: EVENT_BB_POWER_OFF */,
	 6 /* 32: EVENT_PSB_POWER */,
	 6 /* 33: EVENT_BB_NEWSCHEDULE */,
	 6 /* 34: EVENT_BB_NEWSERVICEWINDOW*/,
	 4 /* 35: EVENT_BB_NEWSERVICEWINDOW_INVALID */,
	 6 /* 36: EVENT_BB_V12DC_EXT_SW */,
	 6 /* 37: */,
	 6 /* 38: */,
	 6 /* 39: */,
	 6 /* 40: EVENT_DATACONFIG */,
	 3 /* 41: EVENT_WXT520_INIT_FAIL */,
	 6 /* 42: */,
	 6 /* 43: */,
	 6 /* 44: */,
	 6 /* 45: */,
	 6 /* 46: */,
	 6 /* 47: */,
	 6 /* 48: */,
	 6 /* 49: */,
	 3 /* 50: EVENT_ERROR_SD_MOUNT */,
	 3 /* 51: EVENT_ERROR_SD_GENERIC */,
	 6 /* 52: */,
	 6 /* 53: */,
	 6 /* 54: */,
	 6 /* 55: */,
	 6 /* 56: */,
	 6 /* 57: */,
	 6 /* 58: */,
	 6 /* 59: */,
	 3 /* 60: EVENT_ERROR_RADIO_GENERIC*/,
	 3 /* 61: EVENT_ERROR_RADIO_PATTERN*/,
	 6 /* 62: */,
	 6 /* 63: */,
	 6 /* 64: */,
	 6 /* 65: */,
	 6 /* 66: */,
	 6 /* 67: */,
	 6 /* 68: */,
	 6 /* 69: */,
	 6 /* 70: EVENT_AE_ARM_POWER_ON */,
	 6 /* 71: EVENT_AE_ARM_POWER_OFF */,
	 6 /* 72: EVENT_AE_ARM_RESET */,
	 6 /* 73: EVENT_AE_ARM_COMM_TIMEOUT */,
	 6 /* 74: EVENT_AE_POSTTRIGGER_SET */,
	 6 /* 75: EVENT_AE_THRESHOLD_SET */,
	 6 /* 76: */,
	 6 /* 77: */,
	 6 /* 78: */,
	 6 /* 79: */,
	 6 /* 80: EVENT_WGPS_STARTUP */,
	 6 /* 81: EVENT_WGPS_INIT_PARAMS */,
	 4 /* 82: EVENT_WGPS_CARD_FULL */,
	 4 /* 83: EVENT_WGPS_MEAS_BUSY */,
	 3 /* 84: EVENT_WGPS_ENTER_STOP */,
	 6 /* 85: EVENT_WGPS_SELFTEST_START */,
	 6 /* 86: EVENT_WGPS_SELFTEST_DONE */,
	 3 /* 87: EVENT_WGPS_GPSCUSTOMCFG_FAIL */,
	 6 /* 88: EVENT_WGPS_FIRST_VALID_TIME */,
	 4 /* 89: EVENT_WGPS_GPS_DATALOSS */,
	 3 /* 90: EVENT_WGPS_GPS_FAILURE */,
	 3 /* 91: EVENT_WGPS_MEAS_FAILURE */,
	 3 /* 92: EVENT_WGPS_CARD_INIT_ERROR */,
	 4 /* 93: EVENT_WGPS_STATUS_OVERFLOW */,
	 4 /* 94: EVENT_WGPS_SV_OVERFLOW */,
	 4 /* 95: EVENT_WGPS_EVENT_OVERFLOW */,
	 6 /* 96: EVENT_WGPS_COMMAND_OK */,
	 3 /* 97: EVENT_WGPS_COMMAND_ERROR */,
	 3 /* 98: EVENT_WGPS_MODBUS_ERROR */,
	 4 /* 99: EVENT_WGPS_POWER_STATE_CHANGE */,
	 3 /* 100: EVENT_WGPS_TIME_SYNC_FAILED */,
	 4 /* 101: EVENT_WGPS_GPS_CRC_FAILURE */ );

var deployments = new Array();
var logContainers = new Array()
var selectedDeploymentId;
var selectedLogContainerId;
var scrollPane;
var isPublicGSN = false;

function deployment(name) {
	this.name = name;
	this.identifiers = new Array();
	this.lastEventTime;
	this.lastLogTime;
	this.mappingExists = false;
	this.topologyExists = false;
	this.dozerEventsExists = false;
}

function logContainer(name, deplId, containerId, identifier) {
	this.name = name;
	this.deplId = deplId;
	this.containerId = containerId;
	this.identifier = identifier;
	this.firstTimestamp;
	this.initialized = false;
}

function getTableEnding() {
	if (isPublicGSN)
		return "__mapped";
	else
		return "";
}

function getFieldIdentifier() {
	if (isPublicGSN)
		return "position";
	else
		return "device_id";
}

function getAvailableCoreStations(depl) {
	var deviceIds = new Array();
	if (isPublicGSN && depl.mappingExists) {
		var tableEnding = "";
		$.ajax({
			type: "GET",
	        url: "/field?vs="+depl.name.toLowerCase() + "_mapping_chart&field=DATA&pk=latest",
	        dataType: "xml",
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$("positionContainer",data).each(function(){
					var pos = $(this).attr("position");
					for (var i = 0; i < CORESTATION_TYPES.length; i++) {
						$("positionMap[device_type=" + CORESTATION_TYPES[i] + "]",this).each(function(){
							now = (new Date()).getTime();
							end = $(this).attr("end");
							if (now > parseInt($(this).attr("begin")) && (end == undefined || now < parseInt(end)))
								deviceIds.push(pos);
						});
					}
				});
			}
		});
	}
	else if (depl.topologyExists) {
		var tableEnding = "";
		if (isPublicGSN)
			tableEnding = "__public";
		$.ajax({
			type: "GET",
	        url: "/field?vs="+depl.name.toLowerCase() + "_topology" + tableEnding + "&field=DATA&pk=latest",
	        dataType: "xml",
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$("sensornode[iscorestation=true]",data).each(function(){
					if (isPublicGSN)
						deviceIds.push($(this).attr("position"));
					else
						deviceIds.push($(this).attr("node_id"));
				});
			}
		});
	}
	else {
		var date = new Date((new Date()).getTime()-(LOOK_N_DAYS_BACK*86400000));
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + depl.name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=" + getFieldIdentifier() + "&orderby=generation_time&groupby=" + getFieldIdentifier() + "&critfield=generation_time&neg=&critop=%3E&critval=" + date.getTime(),
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$("line", data).each(function(){
					var l = $("field", this).text();
					if (l != getFieldIdentifier() && l.toLowerCase() != "null")
						deviceIds.push(l)
				});
			}
		});
	}
	return deviceIds.sort(function(a,b){return a - b});
}

function identifierExists(depl, id) {
	var exists = false;
	$.each(depl.identifiers, function() {
		if (id == this) {
			exists = true;
			return false;
		}
	});
	return exists;
}

function getLastLogs(logContainer) {
	var deployment = deployments[logContainer.deplId];
	var date = new Date((new Date()).getTime()-(LOOK_N_DAYS_BACK*86400000));
	if (logContainer.identifier === "dozerevents") {
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=position&fields=device_id&fields=event_id&fields=event_value&fields=timed&orderby=event_timestamp&critfield=event_timestamp&neg=&critop=%3E&critval=" + date.getTime() + "&nb=" + MAX_LOGS_PER_REQUEST,
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$($("line", data).get().reverse()).each(function(i){
					if ($("field:eq(0)", this).text() != "event_timestamp") {
						if (i == 0)
							logContainer.firstTimestamp = $("field:eq(0)", this).text();
						var timed = parseInt($("field:eq(5)", this).text());
						if (deployment.lastEventTime == undefined || deployment.lastEventTime < timed)
							deployment.lastEventTime = timed;
						$('.jspPane',"#logcontainer_" + logContainer.containerId).append(generateEventMessageDiv($("field:eq(0)", this).text(), $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
				});
			}
		});
	}
	else {
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=generation_time&fields=log_message&fields=timed&fieldslinked=false&orderby=generation_time&critfield=" + getFieldIdentifier() + "&neg=&critop==&critval=" + logContainer.identifier + "&critJoin=and&critfield=generation_time&neg=&critop=%3E&critval=" + date.getTime() + "&nb=" + MAX_LOGS_PER_REQUEST,
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$($("line", data).get().reverse()).each(function(i){
					if ($("field:eq(0)", this).text() != "generation_time") {
						if (i == 0)
							logContainer.firstTimestamp = $("field:eq(0)", this).text();
						var timed = parseInt($("field:eq(2)", this).text());
						if (deployment.lastLogTime == undefined || deployment.lastLogTime < timed)
							deployment.lastLogTime = timed;
						$('.jspPane',"#logcontainer_" + logContainer.containerId).append(generateSyslogNgMessageDiv($("field:eq(0)", this).text(), $("field:eq(1)", this).text()));
					}
				});
			}
		});
	}
}

function getMaxLogsRecursive(logContainer, lastGenerationTime) {
	var deployment = deployments[logContainer.deplId];
	if (logContainer.identifier === "dozerevents") {
		var tmp = "";
		if (lastGenerationTime)
			tmp = "&critJoin=and&critfield=event_timestamp&neg=&critop=<&critval=" + lastGenerationTime;
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=position&fields=device_id&fields=event_id&fields=event_value&orderby=event_timestamp&nb=" + MAX_LOGS_PER_REQUEST + tmp,
			async: false,
			cache: false,
			timeout: 30000,
			success: function(data){
				var lastGenTime;
				$("line", data).each(function(){
					if ($("field:eq(0)", this).text() != "event_timestamp") {
						lastGenTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).prepend(generateEventMessageDiv($("field:eq(0)", this).text(), $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
				});
				scrollPane.reinitialise();
				if (lastGenTime && $('.jspPane',"#logcontainer_" + logContainer.containerId).find("div").length < MAX_LOGS_TOTAL)
					getMaxLogsRecursive(logContainer, lastGenTime);
			}
		});
	}
	else {
		var tmp = "";
		if (lastGenerationTime)
			tmp = "&critJoin=and&critfield=generation_time&neg=&critop=<&critval=" + lastGenerationTime;
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=generation_time&fields=log_message&fieldslinked=false&orderby=generation_time&critfield=" + getFieldIdentifier() + "&neg=&critop==&critval=" + logContainer.identifier + "&nb=" + MAX_LOGS_PER_REQUEST + tmp,
			async: false,
			cache: false,
			timeout: 30000,
			success: function(data){
				var lastGenTime;
				$("line", data).each(function(){
					if ($("field:eq(0)", this).text() != "generation_time") {
						lastGenTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).prepend(generateSyslogNgMessageDiv($("field:eq(0)", this).text(), $("field:eq(1)", this).text()));
					}
				});
				scrollPane.reinitialise();
				if (lastGenTime && $('.jspPane',"#logcontainer_" + logContainer.containerId).find("div").length < MAX_LOGS_TOTAL)
					getMaxLogsRecursive(logContainer, lastGenTime);
			}
		});
	}
}

function getLogs() {
	var sdid = selectedDeploymentId;
	var isEvents = logContainers[selectedLogContainerId].identifier === "dozerevents";
	var firstFieldIdentifier = "generation_time";
	if (deployments[sdid].lastLogTime != undefined)
		var crit = "&critfield=timed&neg=&critop=>&critval=" + deployments[sdid].lastLogTime + "&nb=" + MAX_LOGS_TOTAL;
	else
		var crit = "&critfield=timed&neg=&critop=>&critval=" + (new Date()).getTime()-(LOOK_N_DAYS_BACK*86400000) + "&nb=" + MAX_LOGS_TOTAL;
	var query = deployments[sdid].name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=" + firstFieldIdentifier + "&fields=" + getFieldIdentifier() + "&fields=log_message&fields=timed&fieldslinked=false" + crit;
	
	if (isEvents) {
		firstFieldIdentifier = "event_timestamp";
		if (deployments[sdid].lastEventTime != undefined)
			crit = "&critfield=timed&neg=&critop=>&critval=" + deployments[sdid].lastEventTime + "&nb=" + MAX_LOGS_TOTAL;
		
		query = deployments[sdid].name.toLowerCase() + "_dozer_eventlogger__mapped&fields=" + firstFieldIdentifier + "&fields=position&fields=device_id&fields=event_id&fields=event_value&fields=timed" + crit;
	}
	
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + query,
		success: function(data){
			var lastTime;
			$($("line", data).get().reverse()).each(function(){
				var l = $("field:eq(1)", this).text();
				if ($("field:eq(0)", this).text() != firstFieldIdentifier && l.toLowerCase() != "null") {
					var container;
					if (isEvents) {
						container = $('.jspPane',"#logcontainer_" + selectedLogContainerId);
						lastTime = parseInt($("field:eq(5)", this).text());
						container.append(generateEventMessageDiv($("field:eq(0)", this).text(), $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
					else {
						var id;
						var str = $("field:eq(1)", this).text();
						if (!identifierExists(deployments[sdid], str)) {
							if (isPublicGSN)
								id = addNewLogContainer(sdid, str, "CoreStation Pos " + str);
							else
								id = addNewLogContainer(sdid, str, "CoreStation Id " + str);
							deployments[sdid].identifiers.push(str);
						}
						else {
							$.each(logContainers, function() {
								if (this.deplId == sdid && this.identifier == l) {
									id = this.containerId;
									return false;
								}
							});
						}
						container = $('.jspPane',"#logcontainer_" + id);
						lastTime = parseInt($("field:eq(3)", this).text());
						container.append(generateSyslogNgMessageDiv($("field:eq(0)", this).text(), $("field:eq(2)", this).text()));
					}
					
					$($(container).children().get().reverse()).each(
						function(i, elemLi) {
							if(i >= MAX_LOGS_TOTAL)
								$(this).remove();
						}
					);
				}
			});
			if (lastTime != undefined) {
				scrollPane.reinitialise();
				if (isEvents)
					deployments[sdid].lastEventTime = lastTime;
				else
					deployments[sdid].lastLogTime = lastTime;
			}
			setTimeout("getLogs()",UPDATE_INTERVAL*1000);
		}
	});
}

function generateSyslogNgMessageDiv(timestamp, msg) {
	var spl = msg.split(" ", 5);
	var d = new Date(parseFloat(timestamp));
	var logMsg = generateDateString(new Date(parseFloat(timestamp))) + ": " + msg.substring(msg.indexOf(spl[4])+spl[4].length+1, msg.length);
	
	var color = "";
	var priority = parseInt(spl[0].slice(1,spl[0].length-1))%8;
	if (priority == 4)
		color = "; color: chocolate";
	else if (priority <= 3)
		color = "; color: red";
	
	var display = "; display: none";
	if (logMsg.indexOf(getSearchString()) != -1)
		display = "; display: block";
	
	return "<div style=\"width: 10000px" + display + color + "\">" + logMsg + "</div>";
}

function generateEventMessageDiv(timestamp, position, deviceId, eventId, eventValue) {
	var id = parseInt(eventId);
	var logMsg = generateDateString(new Date(parseFloat(timestamp))) + ": Position " + position + " (DeviceId " + deviceId + "): ";
	
	if (eventValue.toLowerCase() == "null") {
		if (EVENT_MSG_NULL[id])
			logMsg += EVENT_MSG_NULL[id];
		else
			logMsg += 'Unknown event id: '+id';
	}
	else {
		if (EVENT_MSG[id])
			logMsg += EVENT_MSG[id].replace('%s', eventValue);
		else
			logMsg += 'Unknown event id: '+id+' (value='+eventValue+')';
	}
	
	var color = "";
	if (EVENT_MSG_ERRORLEVELS[id] == 4)
		color = "; color: chocolate";
	else if (EVENT_MSG_ERRORLEVELS[id] <= 3 || EVENT_MSG_ERRORLEVELS[id] === undefined)
		color = "; color: red";
	
	var display = "; display: none";
	if (logMsg.indexOf(getSearchString()) != -1)
		display = "; display: block";
	
	return "<div style=\"width: 10000px" + display + color + "\">" + logMsg + "</div>";
}

function generateDateString(d) {
	var day = d.getDate();
	if (day < 10) day = "0" + day;
	var month = d.getMonth()+1;
	if (month < 10) month = "0" + month;
	var hours = d.getHours();
	if (hours < 10) hours = "0" + hours;
	var min = d.getMinutes();
	if (min < 10) min = "0" + min;
	var sec = d.getSeconds();
	if (sec < 10) sec = "0" + sec;
	var ms = d.getMilliseconds();
	if (ms < 10) ms = "00" + ms;
	else if (ms < 100) ms = "0" + ms;
	return day + "." + month + "." + d.getFullYear() + " " + hours + ":" + min + ":" + sec + "," + ms;
}
	

function addNewLogContainer(deplId, identifier, menuString) {
	var containerId = logContainers.length;
	$("#log_menu_"+deplId).append('<li style="border-right:0px solid #000000"><a id="log_menu_item_' + containerId + '" href="javascript:showLogs('+deplId+','+containerId+')">' + menuString + '</a></li>');
	$("#logcontainers").append("<div class=\"scroll-pane\" id=\"logcontainer_"+containerId+"\"></div>");
	scrollPane = $(".scroll-pane").jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	logContainers.push(new logContainer(menuString, deplId, containerId, identifier));
	return containerId;
}

function filterLogs(searchString) {
    // make only matched names visible
    $(".jspPane").children().each(function() {
		if ($(this).text().indexOf(searchString) != -1)
			$(this).show();
		else
			$(this).hide();
    });
	scrollPane.scrollTo(0,0);
	scrollPane.reinitialise();
	scrollPane.scrollToBottom();
}

function getSearchString() {
	var tmp = $("#logsearch").val();
	if (tmp == "search logs")
		return "";
	else
		return tmp;
}

$(document).ready(function() {
	$("#starttext").html('Loading log messages... <img src="style/ajax-loader.gif" />');
	$("#logcontainers").hide();
	
	$.get('/menu.jsp', {selected: "logs"}, function(data) {
		$('#navigation').html(data);
	}, 'html');
	$("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

    //bind log search field
	$("#logsearch").css("color", "#bbbbbb");
    $("#logsearch").val("search logs");
    $("#logsearch").focus(function() {
		$("#logsearch").css("color", "#000000");
    	if ($("#logsearch").val() == "search logs")
    		$("#logsearch").val("");
    	else
      		this.select();
    });
    $("#logsearch").keyup(function(event) {
		if ($("#logsearch").val() != "" && $("#logsearch").val() != "search logs") {
			$("#logsearch").css("color", "#000000");
			$("#logsearch_clear").attr("src", "img/button_cancel.png");
	    	if (13 != (event.keyCode || event.which))
				$("#logsearch_go").attr("src", "img/button_go.png");
		}
		else {
			$("#logsearch_clear").attr("src", "img/button_cancel_grey.png");
	    	if (13 == (event.keyCode || event.which))
				$("#logsearch").css("color", "#bbbbbb");
		}
    });
    $("#logsearch").keypress(function(event) {
		$("#logsearch").css("color", "#000000");
    	if (13 == (event.keyCode || event.which)) {
        	filterLogs(getSearchString());
    		$("#logsearch_go").attr("src", "img/button_go_grey.png");
    		if ($("#logsearch").val() == "") {
    	      	$("#logsearch").val("search logs");
    		}
    	}
    });
    $("#logsearch").blur(function(event) {
		if ($("#logsearch").val() == "") {
			$("#logsearch").css("color", "#bbbbbb");
	      	$("#logsearch").val("search logs");
		}
    });
    
    $("#logsearch_clear").click(function() {
		$("#logsearch").css("color", "#bbbbbb");
      	$("#logsearch").val("search logs");
		$("#logsearch_clear").attr("src", "img/button_cancel_grey.png");
		$("#logsearch_go").attr("src", "img/button_go_grey.png");
      	filterLogs(getSearchString());
    });
    $("#logsearch_go").click(function() {
		$("#logsearch_go").attr("src", "img/button_go_grey.png");
      	filterLogs(getSearchString());
    });
	
	// deployments
	// load deployments
	$.ajax({
		type: "GET",
		url: "/gsn?structure",
		success: function(data){
			if ($(document).attr("title")=="GSN") {
			    var gsn = $("gsn",data);
			    $(document).attr("title",$(gsn).attr("name"));
			    $("#gsn-name").empty().append($(gsn).attr("name"));
			    $("#gsn-desc").empty().append($(gsn).attr("description"));
			    $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
			    var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
			    $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
			}
			$("#gsn-name").show();
			uptime.setTime($(gsn).attr("uptime"));
			// iterate over all available virtual sensors
			$("virtual-sensor",data).each(function(){
				// are there syslog-ng or eventlogger__mapped vs available?
				if ($(this).attr("name").indexOf("syslogng") != -1 || $(this).attr("name").indexOf("topology") != -1 || $(this).attr("name").indexOf("mapping_chart") != -1 || $(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1) {
					// private or public?
					if ($(this).attr("name").indexOf("__mapped") != -1)
						isPublicGSN = true;
					
				    var deploymentname = $(this).attr("name").split("_", 1)[0];
				    if(deploymentname.length > 1) {
						deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
						if (deploymentname!='Statistics') {
							var depl;
							$.each(deployments, function(){
								if (this.name == deploymentname) {
									depl = this;
									return false;
								}
							});
							if (depl === undefined) {
								depl = new deployment(deploymentname);
						    	deployments.push(depl);
							}

							// does the deployment offer dozer event logger information?
							if ($(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1)
								depl.dozerEventsExists = true;

							// does the deployment offer mapping_chart information?
							if ($(this).attr("name").indexOf("mapping_chart") != -1)
								depl.mappingExists = true;

							// does the deployment offer topology information?
							if ($(this).attr("name").indexOf("topology") != -1)
								depl.topologyExists = true;
						}
				    }
				}
			});
			// display
			var visible = 0;
			$.each(deployments, function(i, depl) {
				if (this.name == $.cookie("deployment"))
					visible = i;
				
			    // add tab
			    $("#deployment_menu").append($.LI({
				"id":"deployment_menu_item_"+i},
				$.A({
				"href":"javascript:showLogs("+i+",-1)"
			    },depl.name)));
			    
			    $("#deployment_menu_item_"+i).append('<ul id="log_menu_' + i + '" class="subnav" style="z-index: 1" />');
				
				$("#deployment_menu_item_"+i).hover(function() {
					$("#log_menu_"+i).slideDown('fast').show();
					
					$(this).find("ul.subnav").hover(function() {
					}, function(){
						$(this).slideUp('slow');
					});
				}, function() {
					$(this).find("ul.subnav").slideUp('slow');
				});
			    
			    if (depl.dozerEventsExists)
			    	addNewLogContainer(i, "dozerevents", "Dozer Event");
			    
				$.each(getAvailableCoreStations(depl), function(){
					if (isPublicGSN)
						addNewLogContainer(i, this, "CoreStation Pos " + this);
					else
						addNewLogContainer(i, this, "CoreStation Id " + this);
					depl.identifiers.push(this);
				});
			});
			
			$.each(logContainers, function(){
			    getLastLogs(this);
				$("#logcontainer_"+this.containerId).hide();
			});

			$("#logcontainers").show();
			showLogs(visible, -1);
		  	getLogs();
		}
	});
});

function showLogs(deplId, logId) {
	if (deplId != selectedDeploymentId) {
		$("#deployment_menu_item_"+selectedDeploymentId).removeClass("selected");

		$("#deployment_menu_item_"+deplId).addClass("selected");
		$.cookie("deployment" , deployments[deplId].name);
		selectedDeploymentId = deplId;
		
		if (logId == -1) {
			$.each(logContainers, function() {
				if (this.deplId == selectedDeploymentId) {
					logId = this.containerId;
					return false;
				}
			});
		}
	}
	
	if (logId != -1) {
		if (logId != selectedLogContainerId) {
			$("#logcontainer_"+selectedLogContainerId).hide();
			$("#log_menu_item_"+selectedLogContainerId).removeClass("selected");
	
			$("#logcontainer_"+logId).show();
			$("#log_menu_item_"+logId).addClass("selected");
		}
		selectedLogContainerId = logId;
		
		$("#logcontainer_title").text(logContainers[selectedLogContainerId].name + " log messages:");
		var msg = "Shows " + logContainers[selectedLogContainerId].name + " log messages from " + deployments[selectedDeploymentId].name + " deployment.";
		$("#logcontainers").attr("title", msg);
	
		scrollPane = $("#logcontainer_"+logId).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
		scrollPane.reinitialise();
		scrollPane.scrollToBottom();
		
		if (!logContainers[selectedLogContainerId].initialized) {
			$("#starttext").html('Loading ' + logContainers[selectedLogContainerId].name + ' log messages from ' + deployments[selectedDeploymentId].name + ' deployment... <img src="style/ajax-loader.gif" />');
			logContainers[selectedLogContainerId].initialized = true;
			getMaxLogsRecursive(logContainers[selectedLogContainerId], logContainers[selectedLogContainerId].firstTimestamp);
		}
		$("#starttext").html(msg);
	}
}

//]]>-->
</script>
</head>
<body>

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
		<div id="breadcrumbnav"><a href="http://www.permasense.ch">PermaSense</a> > <a href="." id="gsn-name">GSN</a> > Logs</div>
	</div>
	<div id="navigation"></div>
	
	<div class="separator">
		<p id="starttext"></p>
	</div>
	
	
	<div id="maindiv" style="marging:5px 0">

		<div id="deployment_navigation">
		<ul id="deployment_menu" class="topnav">
		</ul>
        <img id="logsearch_clear" style="float:right;margin:5px;" src="img/button_cancel_grey.png" alt="clear filter" />
        <img id="logsearch_go" style="float:right;margin-top:6px;margin-left:5px;" src="img/button_go_grey.png" alt="clear filter" />
		<input id="logsearch" title="Enter search string to filter log messages" style="float:right;width:180px;margin-top:4px;border-style:inset;border-width:1px; " type="text"/>
		</div>
		
		<div id="logcontainer_title" style="text-align:left;margin:10px 0;font-weight:bold"></div>
		
		<div id="logcontainers"></div>
		
	</div>
	
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
