<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GSN</title>

        <script type="text/javascript" src="js/jquery-1.11/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-1.11/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jquery-1.11/jquery.datetimepicker.js"></script>
        <script type="text/javascript" src="js/combobox/chosen.jquery.min.js"></script>
        <link rel="stylesheet" href="js/jquery-1.11/jquery-ui.min.css" type="text/css" media="screen,projection" />
        <link rel="stylesheet" href="js/jquery-1.11/jquery-ui.structure.min.css" type="text/css" media="screen,projection" />
        <link rel="stylesheet" href="js/combobox/chosen.min.css" type="text/css" media="screen,projection" />
        <link rel="stylesheet" href="js/jquery-1.11/jquery.datetimepicker.css" type="text/css" media="screen,projection" />

        <script type="text/javascript" src="js/d3plots/histogram.js"></script>
        <script type="text/javascript" src="js/d3plots/scatterplot.js"></script>
        <script type="text/javascript" src="js/d3plots/timeseries.js"></script>
        <link rel="stylesheet" href="js/d3plots/d3plots.css" type="text/css" media="screen,projection" />

        <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
        <link rel="stylesheet" href="js/jquery-1.11/jquery-ui.theme.min.css" type="text/css" media="screen,projection" />

        <script type="text/javascript" src="js/jquery.flot.pack.js"></script>


        <script type="text/javascript">

            /* XML object loaded from the REQUEST_LIST_OF_VIRTUAL_SENSORS GSN request */
            var lovs = null;
            /* Mapping from virtual sensor name to list of fields name */
            var virtual_sensor_to_fields = []
            var virtual_sensors = [];
            var field_to_virtual_sensor = []
            var field_to_unit = []
            var vss_max_id = 0;
            var fields_max_id = 0;

            var plotIsShown = false;

            $(function(){
                function csv_to_json(tag,callback,format, plot){
                    callback = callback || function(){};
                    var old_value = $('#time_format').val();
                    $('#download_format').val('csv');
                    format = format || 'unix';
                    $('#time_format').val(format);
                    if ($("#ifexists").prop("checked")) $("#ifexists").val("true");
                    prepare_form_for_submission(tag);
                    var params = tag.parents('form').serializeArray();

                    if (plot == true && $("#disablesampling").prop("checked") == false) {
                        params.push({"name": "sample", "value": "true"});
                        if (plotIsShown == false){
                            $("#sampling_percentage").val("-1");
                        }
                    }
                    $.post('multidata', params, function(response, text_status, request){
                        var lines = response.split("\n");
                        var headers = [];
                        var timestamp_idx = -1;
                        var vs_name='';
                        var keys =[];
                        var nb_elements = 0;
                        var datasets = [];
                        for (var line_no=0;line_no<lines.length;line_no++){
                            var line = $.trim(lines[line_no]);
                            if (line.length == 0)
                                continue;

                            if(line[0]=='#'){ //comment lines
                                if (line.indexOf("# vsname:") >= 0){
                                    vs_name = line.substring(9,line.length);
                                    keys=[];
                                    headers=[];
                                } else if (line.indexOf("# time") >= 0) { //field name
                                    headers = line.split(',');
                                    for (var i=0;i<headers.length;i++){
                                        headers[i] = headers[i].replace("#","");
                                        headers[i] = headers[i].replace(" ","");
                                        if (headers[i]=='time') {
                                            timestamp_idx=i;
                                        } else {
                                            lbl = vs_name+' ('+headers[i]+')';
                                            datasets[lbl]={label: lbl, data: []};
                                            keys.push(lbl);
                                        }
                                    }
                                } else{
                                }
                            }else { // data line, at this stage we should have a header varialbe already set.
                                var data = line.split(',');
                                var timestamp = data[timestamp_idx];
                                for (i=0, k=0;i<headers.length;i++){
                                    if(i != timestamp_idx && data[i]!=undefined ){
                                        if (format == 'unix') {
                                            datasets[keys[k]].data.push([parseInt(timestamp),parseFloat(data[i])]);
                                        } else {
                                            datasets[keys[k]].data.push([timestamp,parseFloat(data[i])]);
                                        }
                                        nb_elements++;
                                        k++;
                                    }
                                }
                            }
                        }
                        $('#time_format').val(old_value);
                        if (plot == true) {
                            $('#progressbar').progressbar("disable");
                            $('#plotContainer').empty();

                            if (plotIsShown == false){
                                plotIsShown = true;
                                $(".sampling_percentage").show();
                                $("#sampling_percentage").val("");
                            }
                        }
                        callback(datasets,nb_elements);
                    });
                }

                function parse_minmax_vals_for_slider(sensor, field, slider, min, max){

                    $.get('rest/sensors/'+sensor+'/'+field+'/minmax', {}, function(response, text_status, request){
                    //alert("features "+response['features'][0].properties['values'][0][3]);
                        var result = response['features'][0];
                        var minVal = result.properties['values'][0][3];
                        var maxVal = result.properties['values'][0][2];
                        var disabled = false;
                        if (minVal == null || maxVal == null){
                            minVal = 0;
                            maxVal = 100;
                            disabled = true;
                        }

                        slider.slider({
                            range: true,
                            min: minVal,
                            max: maxVal,
                            disabled: disabled,
                            values: [ minVal, maxVal ],
                            slide: function (event, ui) {
                                $(this).parent().children(".min").val(ui.values[ 0 ]);
                                $(this).parent().children(".max").val(ui.values[ 1 ]);
                            }
                        });
                        //min.val(response[0]['values'][0][3]);
                        //max.val(response[0]['values'][0][2]);

                    });
                }



                function getSortedKeys(obj){
                    var keys = [];
                    for(var key in obj){
                        keys.push(key);
                    }
                    return keys.sort();
                }

                function getSortedValues(obj){
                    var values = [];
                    for(var value in obj){
                        values.push(value);
                    }
                    return values.sort();
                }

                function add_auto_complete_one_sensor(name){
                    to_return = '<select name="' + name + '" class="' + name+ '"></select>';
                    virtual_sensors.sort();
                    return to_return;
                }

                function option_list_key(name,items,all, id){
                    to_return = '<select name="' + name + '" class="' + name+ '" id="' + id+ '">'
                    if (all){
                        to_return+='<option value="All" >' + all + '</option>';
                    }


                    var sk = getSortedKeys(items);
                    var l = sk.length;
                    for (var i = 0 ; i < l ; i++) {
                        if ("time" == sk[i]) continue;
                        to_return+='<option value="' + sk[i]+'" >'+sk[i]+'</option>';
                    }
                    to_return+='</select>'
                    return to_return;
                }

                function option_list_value(name,items,all, units, id){
                    to_return = '<select name="' + name + '" class="' + name+ '" id="' + id+ '">'
                    if (all!=null){
                        to_return+='<option value="All" >' + all + '</option>';
                    }
                    var sv = getSortedValues(items);
                    var l = sv.length;
                    for (var i = 0 ; i < l ; i++) {
                        if ("time" == items[sv[i]]) continue;
                        if (units[items[sv[i]]]==null || units[items[sv[i]]]=="")
                            to_return+='<option value="' + items[sv[i]]+'" >'+items[sv[i]]+'</option>';
                        else
                            to_return+='<option value="' + items[sv[i]]+'" >'+items[sv[i]] + " [" + units[items[sv[i]]] + "]" +'</option>';
                    }
                    to_return+='</select>'
                    return to_return;
                }


                function add_data_output () {

                    var vss_id = "vss_" + vss_max_id;
                    var fields_id = "fields_" + fields_max_id;
                    var fields_div_id  = "fields_div_id_" + fields_max_id;
                    vss_max_id++; fields_max_id++;
                    var data_outputs_content = '<li>';
                    data_outputs_content += option_list_key('vss', virtual_sensor_to_fields, "All Virtual Sensors", vss_id);
                    data_outputs_content += '<div name="fields" class="fields" style="display: inline-block;" id="' + fields_div_id+ '"></div>';
                    data_outputs_content += '<div class="condition-slider" style="display: inline-block;"></div>';
                    data_outputs_content += '<a class="remove-criterion" href="#"> Remove</a></li>';
                    $('#data-outputs').append(data_outputs_content);


                    $('#'+vss_id).chosen({
                        search_contains: true,
                        width: "200px"
                    });
                    $('#'+vss_id).on('change', function(evt, params){
                        var vs = $(this).val();
                        if (vs != 'All') {
                            $('#'+fields_div_id).html("&nbsp " + option_list_value('fields',virtual_sensor_to_fields[vs],"All Fields", field_to_unit[vs], fields_id));
                            $('#'+fields_id).chosen({
                                search_contains: true,
                                width: "150px"
                            });
                            $('#'+fields_id).on('change', function(evt, params){
                                if ($(this).val() != 'All' && $('#'+vss_id).val() != 'All') {
                                    $(this).parent().parent().children('.condition-slider').show();
                                    var conditions_content = '&nbsp<input type="text" class="min" style="font-weight:bold; width:30px; display: inline-block;"/>';
                                    conditions_content += '&nbsp &nbsp';
                                    conditions_content += '<div class="slider-range" style="width: 200px; display: inline-block"></div>';
                                    conditions_content += '&nbsp &nbsp';
                                    conditions_content += '<input type="text" class="max" style="font-weight:bold; width:30px;"/>';
                                    conditions_content += '<input type="text" class="c_vs" style="display: none;"/>';
                                    conditions_content += '<input type="text" class="c_field" style="display: none;"/>';
                                    conditions_content += '<input type="text" class="join" value="and" style="display: none;"/>';
                                    $(this).parent().parent().children('.condition-slider').html(conditions_content);
                                    parse_minmax_vals_for_slider($('#'+vss_id).val(), $(this).val(),
                                            $(this).parent().parent().children('.condition-slider').children(".slider-range"),
                                            $(this).parent().parent().children('.condition-slider').children(".min"),
                                            $(this).parent().parent().children('.condition-slider').children(".max")
                                    );

                                    $(this).parent().parent().children('.condition-slider').children(".min").val("-inf");
                                    $(this).parent().parent().children('.condition-slider').children(".max").val("+inf");
                                } else {
                                    $(this).parent().parent().children('.condition-slider').hide();
                                }
                            });
                        }
                        else {
                            $('#'+fields_div_id).html("");
                        }
                        $(this).parent().children('.condition-slider').hide();
                    });

                    $('.remove-criterion').click (function() {
                        if ($(this).parent().parent().children().size() > 1) {
                            $(this).parent().remove();
                        }
                    });
                }

                function prepare_form_for_submission(tag){
                    var counter = 0;
                    tag.parents('form').find('.data-outputs-container li').each(function(){
                        $(this).find('.vss').each(function(){
                            $(this).chosen().attr("name", 'vs['+counter+']');
                            var vssId = $(this).attr('id');
                            vssId = parseInt(vssId.split("_")[1]);
                            if (typeof $("#toDelete") != "undefined") $("#toDelete").remove();
                            if ($(this).chosen().val() == "All"){
                                $(this).append('<input id="toDelete" name="field[0]" value="All"/>');
                                return;
                            }

                            $("#fields_" + vssId).chosen().attr("name", 'field['+counter+']');
                            if (typeof $("#fields_" + vssId).chosen().val() == "undefined"){
                                $("#fields_" + vssId).chosen().val('All');
                            }
                            if ($("#fields_div_id_"+vssId).next().html() != ""){

                                var skip = 0;
                                $("#fields_div_id_"+vssId).next().find('.min').each(function(){
                                    if ($(this).val() == "-inf") {
                                        $("#fields_div_id_"+vssId).next().find('.max').each(function(){
                                            if ($(this).val() == "+inf") skip  = 1;
                                        });
                                    }
                                });

                                if (skip == 0) {

                                    $("#fields_div_id_" + vssId).next().find('.c_vs').each(function () {
                                        $(this).attr('name', 'c_vs[' + counter + ']');
                                        $(this).val($("#vss_" + vssId).chosen().val());
                                    });
                                    $("#fields_div_id_" + vssId).next().find('.c_field').each(function () {
                                        $(this).attr('name', 'c_field[' + counter + ']');
                                        $(this).val($("#fields_" + vssId).chosen().val());
                                    });
                                    $("#fields_div_id_" + vssId).next().find('.min').each(function () {
                                        $(this).attr('name', 'c_min[' + counter + ']');
                                    });
                                    $("#fields_div_id_" + vssId).next().find('.max').each(function () {
                                        $(this).attr('name', 'c_max[' + counter + ']');
                                    });
                                    $("#fields_div_id_" + vssId).next().find('.join').each(function () {
                                        $(this).attr('name', 'c_join[' + counter + ']');
                                    });
                                }
                            }
                            counter++;
                        });

                    });
                }

                /** Load the REQUEST_LIST_OF_VIRTUAL_SENSORS xml and create the mapping */
                $.get("gsn?REQUEST=0&omit_latest_values=true", function(xml){
                    lovs = xml
                    virtual_sensors.push("All");

                    $('virtual-sensor',xml).each(function(){
                        var vsname = $(this).attr('name');
                        virtual_sensors.push(vsname);
                        virtual_sensor_to_fields[vsname] = virtual_sensor_to_fields[vsname] || []
                        $(this).find('field').each(function(){
                            if ($(this).attr('category') != 'predicate') {
                                var field_name = $(this).attr('name');
                                var field_unit = $(this).attr('unit');
                                virtual_sensor_to_fields[vsname].push(field_name);
                                field_to_virtual_sensor[field_name] = field_to_virtual_sensor[field_name] || []
                                field_to_virtual_sensor[field_name].push(vsname)

                                if (!field_to_unit[vsname]){
                                    field_to_unit[vsname] = [];
                                }
                                if (!field_to_unit[vsname][field_name]){
                                    field_to_unit[vsname][field_name] = [];
                                }
                                field_to_unit[vsname][field_name].push(field_unit)
                            }
                        });
                    });
                    add_data_output ();
                });

                $('#add-data-output').click(function () {
                    add_data_output();
                });

                $('#nb').change(function(){
                    var val = $(this).val();
                    if (val == 'ALL') {
                        $('#nb_value_div').hide();
                    } else {
                        $('#nb_value_div').show();
                    }
                });

                $('#agg_function').change(function(){
                    $('#agg_period').attr('disabled',$(this).val() == '-1');
                    $('#agg_unit').attr('disabled',$(this).val() == '-1');
                });

                $("#datepicker_from, #datepicker_to").datetimepicker({format: "d/m/Y H:i:s" });

                $('.download_btn_csv').click(function(){
                    $('#download_format').val('csv');
                    prepare_form_for_submission($(this));
                    return true;
                });

                $('.download_btn_xml').click(function(){
                    $('#download_format').val('xml');
                    prepare_form_for_submission($(this));
                    return true;
                });



                $(".plot").click(function(){
                    datasets={};
                    var choice = $("#plot-type").val();
                    $('#plotContainer').html('</br><div id="progressbar" style="width: 200px; margin-left: auto; margin-right: auto"></div>');
                    if (choice == '') return;



                    $('#progressbar').progressbar({
                        value: false
                    });
                    $('#progressbar').progressbar("enable");
                    var progressbarValue = $( '#progressbar' ).find( ".ui-progressbar-value" );
                    progressbarValue.css({
                        "background": '#77cc66'
                    });

                    datasets={};
                    if (choice == 'drawHistogram') csv_to_json($(this),drawHistogram, 'unix', true);
                    else if (choice == 'drawScatterplot') csv_to_json($(this),drawScatterplot, 'unix', true);
                    else if (choice == 'drawTimeseries') csv_to_json($(this),drawTimeseries, 'unix', true);


                });

                $(".sampling_percentage").hide();
                $("#disablesampling").change(function(){
                    if ($("#disablesampling").prop("checked")){
                        $(".sampling_percentage").hide();
                    } else {
                        if (plotIsShown == true) {
                            $(".sampling_percentage").show();
                        }
                    }
                });


                $.get('menu.jsp', {selected: "data"}, function(data) {
                    $('#navigation').html(data);
                });


 $(".grid").click(function(){
function drawGrid(l_datasets){
$("#sensorSelect").empty();
$("#sensorSelect").append('<option value="">Select a Virtual Sensor</option>');
var displayed = [];
for (var sensor in l_datasets) {
sensor = sensor.split(' ')[0];
if ($.inArray(sensor, displayed) < 0) {
displayed.push(sensor);
option = $("<option value=\"" + sensor + "\">" + sensor + "</option>");
$("#sensorSelect").append(option);
}
}
datasets = l_datasets;
$("#sensorSelect").change(function(){
var choice = $("#sensorSelect").val();
$('#gridContainer').empty();
if (choice == '') return;
// columns
var fields = [];
// column headers
var headers = [];
for (var sensor_field in datasets) {
if (sensor_field.substring(0, choice.length) == choice) {
fields.push(datasets[sensor_field]);
headers.push(sensor_field.substring(choice.length + 2, sensor_field.length - 1));
}
}
var data_length = fields[0]['data'].length;
var grid = '<table id="grid" class="tablesorter" border="0" cellpadding="0" cellspacing="1"><thead><tr><th>time</th>';
for (var i = 0; i < headers.length; i++) {
grid += '<th>' + headers[i] + '</th>';
}
grid += '</tr></thead><tbody>';
for (var i = 0; i < data_length; i++) {
// bug with the csv_to_json function: the last row is empty
if (fields[0]['data'][i][0]) {
grid += '<tr><td>' + fields[0]['data'][i][0] + '</td>';
for (var j = 0; j < fields.length; j++) {
grid += '<td>' + fields[j]['data'][i][1] + '</td>'
}
grid += '</tr>';
}
}
grid += '</tbody></table>';
$('#gridContainer').html(grid);
$('#grid').tablesorter({
widthFixed: true,
widgets: ['zebra']
});
});
}
datasets = {};
csv_to_json($(this), drawGrid, 'iso');
});

            });
        </script>
    </head>
    <body>
        <div id="container">
            <div id="header">
                <h1><a href="." id="gsn-name">GSN</a></h1>
            </div>
            <div id="navigation" style="text-align:right;">
            </div>
            <div id="main" class="full-page">
                <noscript><p class="error">Your browser doesn't appear to support JavaScript. This is most likely because you're using a text-based or otherwise non-graphical browser. Sadly, GSN require javascript in order to work properly. If you want to access directly the data, you can use the api at <a href="http://localhost:22001/gsn">http://localhost:22001/gsn</a>.</p></noscript>
                <!-- data part -->
                <br/> <br/> <br/>
                <div id="datachooser">
                    <div id="data_1" class="clearfix">
                        <form action="multidata" method="post">

                                    <div class="data-output-content">
                                        <div class="aggregations">
                                            <div>
                                                <select id="nb" name="nb" style="display: inline-block">
                                                    <option value="ALL">All Data</option>
                                                    <option value="SPECIFIED" selected="selected">Only</option>
                                                </select>
                                                <div id="nb_value_div" style="display: inline-block">
                                                    <input id="nb_value" name="nb_value" size="3" type="text" value="10"/><span> Values</span>
                                                </div>
                                            </div>
                                            <p>
                                                <span>Aggregation</span>
                                                <select id="agg_function" name="agg_function">
                                                    <option value="-1">No Aggregation</option>
                                                    <option value="avg">AVG</option>
                                                    <option value="max">MAX</option>
                                                    <option value="min">MIN</option>
                                                    <option value="sum">SUM</option>
                                                </select>
                                                <input disabled="disabled" id="agg_period" name="agg_period" size="5" type="text" value="2" />
                                                <select disabled="disabled" id="agg_unit" name="agg_unit">
                                                    <option value="3600000">Hours</option>
                                                    <option value="60000">Minutes</option>
                                                    <option value="1000">Seconds</option>
                                                    <option value="1">Milli Seconds</option>
                                                </select>
                                            </p>
                                        </div>
                                        </br> </br>
                                        <div class="data-outputs-container">
                                            <a id="add-data-output" href="#">Add Output</a>
                                            <ul id="data-outputs"></ul>
                                        </div>
                                        </br>
                                        <div class="time-range">
                                            <div>
                                                </br>
                                                <span>From</span>
                                                <input id="datepicker_from" name="from" type="text" value=""   style="width: 150px"/>
                                                &nbsp
                                                <span>To</span>
                                                <input id="datepicker_to" name="to" type="text" value=""  style="width: 150px"/>
                                            </div>
                                            <input id="ifexists" type="checkbox" name="ifexists" value="false" checked/>
                                            <span>Add virtual sensor only if it has data in the given time period</span>
                                            </br> </br>
                                        </div>
                                    </div>
                                    </br></br></br>

                                    <div class="plot-content">
                                        <span>Plot Type</span>
                                        <select id="plot-type">
                                            <option value="drawTimeseries" selected="selected">Timeseries</option>
                                            <option value="drawScatterplot">Scatterplot</option>
                                            <option value="drawHistogram">Histogram</option>
                                        </select>
                                        <input class="ui-default-state plot" name="commit" type="button" value="Plot" />
                                        <div style="display: inline-block" class="sampling_percentage" ><span>Sampling rate</span>&nbsp<input id="sampling_percentage" style="width: 30px" type="text" name="sampling_percentage"/><span>%</span></div>
                                        &nbsp&nbsp&nbsp
                                        <input id="disablesampling" type="checkbox" name="disablesampling"/><span>Disable sampling</span>
                                    </div>

                                    </br></br>

                                    <div class="results-content">
                                        <input class="ui-default-state download_btn_csv" name="commit" type="submit" value="Download CSV" />
                                        <input class="ui-default-state download_btn_xml" name="commit" type="submit" value="Download XML" />
                                         <span>Time Format</span>
                                        <select id="time_format" name="time_format"><option value="iso">ISO 8601</option><option value="unix">UNIX</option></select>
                                        <input id="download_format" type="hidden" name="download_format" value="csv"/>
                                        <input id="reportclass" type="hidden" name="reportclass" value="report-default"/>
                                    </div>

                                    <div id="plotContainer">
                                    </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="footer">
                <p>Powered by <a href="https://github.com/LSIR/gsn">GSN</a>,  Distributed Information Systems Lab, EPFL 2014</p>
                <p>
                    <a href="http://validator.w3.org/check?uri=referer"><img src="./img/html_valid.bmp"/></a>
                    <a href="http://jigsaw.w3.org/css-validator/check?uri=referer"><img src="./img/css_valid.bmp"/></a>
                </p>
            </div>

        </div>
    </body>
</html>
