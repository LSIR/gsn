<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GSN</title>
        <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />

 	 	<script type="text/javascript" src="js/jquery-1.11/jquery-1.11.1.min.js"></script>
 	 	<script type="text/javascript" src="js/chosen-1.4.2/chosen.jquery.min.js"></script>
 	 	<link rel="stylesheet" href="js/chosen-1.4.2/chosen.min.css" type="text/css" media="screen,projection" />
 	 	<script type="text/javascript" src="js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
 	 	<link rel="stylesheet" href="js/jquery-ui-1.11.4/jquery-ui.min.css" type="text/css" media="screen,projection" />
 	 	<script type="text/javascript" src="js/jquery-dom.js"></script>
        <script type="text/javascript" src="js/jquery.history.js"></script>
        <script type="text/javascript" src="js/jquery-tooltip.js"></script>
 	 	
 	 	<link rel="stylesheet" href="style/map.css" type="text/css" media="screen,projection" />
 	 	
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
       
        <script type="text/javascript" src="js/constants.js"></script>
        <script type="text/javascript" src="js/functions.js"></script>
        <script type="text/javascript" src="js/gsn.js"></script>
        
        <script type="text/javascript">
        
            <!--//<![CDATA[ -->

            var vsBasket = new Array();
            
        	// Function called in gsn.js
	        function putInVsBasket(cb) {
        		var vsName = cb.value;
	    		if(cb.checked) {
	    			vsBasket.push(vsName);
	    			$("#vsbasket").append("<div class=\"vsbasket_elem\" id=\"basket_" + vsName + "\"><input type=\"checkbox\" id=\"basket_cb_" + vsName + "\" value=\"" + vsName + "\" onclick=\"putInVsBasket(this);\" checked />" + vsName + "</div>");
	    			$("#basket_cb_" + vsName).attr("checked", true);
	    			$("#map_cb_" + vsName).attr("checked", true);
	    		} else {
	    			vsBasket.splice($.inArray(vsName,vsBasket),1);
	    			$("#basket_" + vsName).remove();
	    			$("#basket_cb_" + vsName).attr("checked", false);
	    			$("#map_cb_" + vsName).attr("checked", false);
	    		}
	    	}
        	
        	function updateMapMarkersDisplay() {
        		var mapBounds = map.getBounds();
       			var selectedObsProp = $("#observedProperties").chosen().val();
               	if (GSN.map.areVisible && selectedObsProp != null) {
               		if ($.inArray("any",selectedObsProp) != -1) {
               			for (x = 0; x < GSN.map.markers.length; x++) {
               				var m = GSN.map.markers[x];
    	                    var vsName = m.vsname;
    	                    if (mapBounds.contains(m.getPosition())) {
    	                    	m.setVisible(true);
        	                 	showSensorToVsMenu(vsName);
    	                    } else {
    	                    	m.setVisible(false)
		                		hideSensorFromVsMenu(vsName);
    	                    }
               			}
               		} else {
               			// Show or hide markers based on the observed properties filter and the bounds of the map
    	            	for (x = 0; x < GSN.map.markers.length; x++) {
    	                    var m = GSN.map.markers[x];
    	                    var vsName = m.vsname;
   	    	                for (i = 0; i < selectedObsProp.length; i++) {
   		                		if (undefined != obsPropVsMap.get(selectedObsProp[i])) {
   		                			if ($.inArray(vsName,obsPropVsMap.get(selectedObsProp[i])) != -1 && mapBounds.contains(m.getPosition())) {
   		                				m.setVisible(true)
   		                				showSensorToVsMenu(vsName);
   		                				break; // One observed property is enough to display the sensor (logical OR)
   		                			} else {
   		                				m.setVisible(false)
   		                				hideSensorFromVsMenu(vsName);
   		                			}
   		                		} else {
   		                			m.setVisible(false)
   		                			hideSensorFromVsMenu(vsName);
   		                		}
   		                	}
    	            	}
               		}
               	} else if (selectedObsProp == null) {
               		for (x = 0; x < GSN.map.markers.length; x++) {
               			var m = GSN.map.markers[x];
	                    var vsName = m.vsname;
	                    m.setVisible(false)
	                    hideSensorFromVsMenu(vsName);
    	           	}
               	}
               	
               	function showSensorToVsMenu(vsName) {
               		$("#menu-"+vsName).parent().show();
               	}
               	
               	function hideSensorFromVsMenu(vsName) {
               		$("#menu-"+vsName).parent().hide();
               	}
        	}
        	
	        var obsPropVsMap = new Map();
            
            $(document).ready(function() {
            	
                $.get('menu.jsp', {selected: "map"}, function(data) {
                    $('#navigation').html(data);
                });

                //bind every buttons to javascript functionality (only once)
                $("#refreshall_timeout").bind("change",GSN.updateallchange);
                $("#refreshall").bind("click",GSN.refreshVSs);
                <!--$("#toggleallmarkers").bind("click",GSN.map.toggleAllMarkers);-->
                $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

               	$("#observedProperties").chosen({
                       search_contains: true,
                       width: "200px",
                       no_results_text: "No property found, try \"any\"",
                       placeholder_text_multiple: "Select some properties"
                });
               	
               	$("#observedProperties").chosen().change(function(e, params) {
               		updateMapMarkersDisplay();
               	});
              	
              	var obsPropArray = new Array();
                
               	$.ajax({
   		    	    type: "GET",
   		    	    url: "ext/ws/api/sensors?format=xml",
   		    	    success: function(data){
   		    	    	$("virtual-sensor",data).each(function(){
   		    	    		var vsName = $(this).attr("name");
   		    	    		$("field",this).each(function(){
   		    	    			var obsProp = $(this).attr("obsProperty");
   		    	    			if (undefined != obsProp) {
   		    	    				if ($.inArray(obsProp,obsPropArray) == -1) {
   		    	    					obsPropArray.push(obsProp);
   		    	    				}
   		    	    				var vsArray = obsPropVsMap.get(obsProp);
   		    	    				if (undefined != vsArray) {
   		    	    					obsPropVsMap.get(obsProp).push(vsName)
   		    	    				} else {
   		    	    					obsPropVsMap.set(obsProp, new Array(vsName));   		    	    					
   		    	    				}
   		    	    			}
   		    	    		});
   		    	        });
   		    	    	obsPropArray.sort();
   		    	    	for (i = 0; i < obsPropArray.length; ++i) {
	   		    	    	$('#observedProperties').append($('<option>', {
	   	    				    value: obsPropArray[i],
	   	    				    text: obsPropArray[i]
	   	    				}));
   		    	    	}
   		    	    	$("#observedProperties").trigger("chosen:updated");
   		    	    }
   		    	});
               	
               	$("#send_basket_to_data").on('click', function() {
               		var url = "data.html?";
               		var propVsBasket = $('#observedProperties').chosen().val();
               		
               		if (vsBasket.length == 0) {
               			return;
               		} else if (vsBasket.length == 1) {
                    	url += $.param({vsname: vsBasket, propbasket: propVsBasket}) + "#data";
               		} else {
                    	url += $.param({vsbasket: vsBasket, propbasket: propVsBasket}) + "#data";
               		}
               		
               		window.location.href = url;
               	});
               	
               	GSN.load();
            });
            
            <!--//]]>-->
        </script>

    </head>
    <body onunload="">

        <div id="container">
            <div id="header">
                <h1><a href="." id="gsn-name">GSN</a></h1>
            </div>
            <div id="navigation">
            </div>
            <div id="main">
                <noscript><p class="error">Your browser doesn't appear to support JavaScript. This is most likely because you're using a text-based or otherwise non-graphical browser. Sadly, GSN require javascript in order to work properly. If you want to access directly the data, you can use the api at <a href="http://localhost:22001/gsn">http://localhost:22001/gsn</a>.</p></noscript>

         	   <div class="panel panel-default" style="width:68%;float:left;">
		       <div id="control panel-body">
                    <iframe name="webupload" style="border:0;height:0;width:0;"></iframe>
                    <div id="msg">Welcome to Global Sensor Networks. The first ten sensors are displayed by default, but you can easily close them with the <em>close all</em> button. By clicking on a virtual sensors on the left sidebar, it will bring it to the top of the list.</div>

                    <p>Auto-refresh every :
                        <select id="refreshall_timeout" >
                            <option value="3600000">1hour</option>
                            <option value="600000">10min</option>
                            <option value="60000" selected="selected">1min</option>
                            <option value="30000">30sec</option>
                            <option value="5000">5sec</option>
                            <option value="1000">1sec</option>
                            <option value="0">disable</option>
                        </select>
                        <input id="refreshall" type="button" value="refresh" />
                        <span class="refreshing"><img src="style/ajax-loader.gif" alt="loading" title="" /></span>
                    </p>
                </div>

                <div id="homediv">
                    <div id="vs">
                        <div class="loading">Virtual sensors are currently loading...</div>
                    </div>
                </div>


                <!-- map part -->
                <div id="mapdiv">

                    <!-- <h2>Global Sensor Network Map</h2> -->
                    <p><a style="text-decoration:underline" href="javascript:GSN.map.showAllMarkers();">Auto-zoom and focus the map</a></p>
                    <div id='selectMapProvider'>
                       <!-- <input type="radio" id="VE" class="mapProvider" name="mapProvider" onclick="location.href='map.html?mapProvider=microsoft';" value="VE">Virtual Earth
                        <input type="radio" id="GM" class="mapProvider" name="mapProvider" onclick="location.href='map.html?mapProvider=google';" value="GM">Google Maps
                        -->
                        <!--<input type="radio" id="YM" class="mapProvider" name="mapProvider" onclick="location.href='map.html?mapProvider=yahoo';" value="YM">Yahoo Maps -->
                    </div>
                    <div id="vsmap" style="width: 100%; height: 500px; position:relative;"></div>
                    <div id="vs4map"></div>
                </div>

            </div>
            <div id="sidebar">
                <h3>Description</h3>
                <p id="gsn-desc">none</p>
                <h3>Author</h3>
                <p id="gsn-author">none</p>
                <h3>Virtual sensors</h3>
                <div class="observedproperties-autocomplete">
					<label for="observedProperties">Filter by choosing observed properties: </label><br>
					<select name="observedProperties" id="observedProperties" multiple>
						<option selected value="any">Any</option> 
                   	</select>'
                </div>
                <ul id="vsmenu">
                    <li><a href="#">not loaded</a></li>
                </ul>
                <!--<p><input class="hidden" id="toggleallmarkers" type="button" value="Show/hide all markers" /></p>-->
                <ul id="vsbasket">
                	<div class="rubric_vsbasket">Basket</div>
                </ul>
                <p class="vsbasket_button"><input id="send_basket_to_data" type="button" value="Load basket in data" /></p>
            </div>
            </div>
            <div id="footer">
                <p>Powered by <a href="https://github.com/LSIR/gsn">GSN</a>,  Distributed Information Systems Lab, EPFL 2014</p>
                <p>
                    <a href="http://validator.w3.org/check?uri=referer"><img src="./img/html_valid.bmp"/></a>
                    <a href="http://jigsaw.w3.org/css-validator/check?uri=referer"><img src="./img/css_valid.bmp"/></a>
                </p>
            </div>
        </div>
    </body>
</html>
